<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://openvers.github.io/docs_blog/docs/><link rel=alternate type=application/rss+xml href=https://openvers.github.io/docs_blog/docs/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/docs_blog/favicons/favicon.ico><link rel=apple-touch-icon href=/docs_blog/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/docs_blog/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/docs_blog/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/docs_blog/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/docs_blog/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/docs_blog/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/docs_blog/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/docs_blog/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/docs_blog/favicons/android-192x192.png sizes=192x192><title>Documentation | OpenVERS</title><meta name=description content="OpenVERS Documentation"><meta property="og:title" content="Documentation"><meta property="og:description" content="OpenVERS Documentation"><meta property="og:type" content="website"><meta property="og:url" content="https://openvers.github.io/docs_blog/docs/"><meta property="og:site_name" content="OpenVERS"><meta itemprop=name content="Documentation"><meta itemprop=description content="OpenVERS Documentation"><meta name=twitter:card content="summary"><meta name=twitter:title content="Documentation"><meta name=twitter:description content="OpenVERS Documentation"><link rel=preload href=/docs_blog/scss/main.min.44e056411013bf8f18a255176cfb0420600587168abb56228837c1f35a8df1c0.css as=style><link href=/docs_blog/scss/main.min.44e056411013bf8f18a255176cfb0420600587168abb56228837c1f35a8df1c0.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/docs_blog/><span class="navbar-brand__logo navbar-logo"><svg width="128" height="128" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><title>OpenVERS Icon - White Background</title><desc>A dimensional icon for Open Data Versatility with a white background circle. It features an open deep blue ring and three bright teal lines with an enhanced extruded effect suggesting depth.</desc><style>.fill-none{fill:none}.stroke-linecap-round{stroke-linecap:round}.circle-main-style{stroke:#3b4856;stroke-width:10}.circle-depth-style{stroke:#072a5c;stroke-width:10}.line-main-style{stroke:#009cff;stroke-width:8}.line-depth-style{stroke:#007a8a;stroke-width:8}.line-accent-shadow-style{stroke:#005f6b;stroke-width:2}.bg-circle-style{fill:#fff}</style><circle class="bg-circle-style" cx="50" cy="50" r="50"/><path d="M86.5 51.5a35 35 0 11-35-35" class="fill-none stroke-linecap-round circle-depth-style"/><path d="M85 50A35 35 0 1150 15" class="fill-none stroke-linecap-round circle-main-style"/><g class="fill-none stroke-linecap-round line-accent-shadow-style"><line x1="52.5" y1="52.5" x2="79.5" y2="25.5"/><line x1="52.5" y1="52.5" x2="26.5" y2="37.5"/><line x1="52.5" y1="52.5" x2="52.5" y2="82.5"/></g><g class="fill-none stroke-linecap-round line-depth-style"><line x1="51.5" y1="51.5" x2="78.5" y2="24.5"/><line x1="51.5" y1="51.5" x2="25.5" y2="36.5"/><line x1="51.5" y1="51.5" x2="51.5" y2="81.5"/></g><g class="fill-none stroke-linecap-round line-main-style"><line x1="50" y1="50" x2="77" y2="23"/><line x1="50" y1="50" x2="24" y2="35"/><line x1="50" y1="50" x2="50" y2="80"/></g></svg></span><span class=navbar-brand__name>OpenVERS</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs_blog/about/><span>About</span></a></li><li class=nav-item><a class=nav-link href=/docs_blog/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/docs_blog/community/><span>Community</span></a></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs_blog/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Documentation</h1><ul><li>1: <a href=#pg-be9f1ecae30cf02a3da539a6993d5d2d>Cloud Setup</a></li><ul><li>1.1: <a href=#pg-913dc8e708929c01dde440b8c83e37e5>Github</a></li><li>1.2: <a href=#pg-48173e7a425474aab8947f97578b3238>Terraform.io</a></li><li>1.3: <a href=#pg-5b0f2c912434cb90a51bdfe1ef7bda08>Amazon Web Services (AWS)</a></li><ul><li>1.3.1: <a href=#pg-de7870d69afa943e168922a0fd5a7a72>Account Setup</a></li><li>1.3.2: <a href=#pg-3e4fabc8274bcec82d993873a23131d2>Terraform Backend</a></li><li>1.3.3: <a href=#pg-1d14e8c6f158f84d87904be72d1a74c4>OpenID Connect</a></li></ul><li>1.4: <a href=#pg-e9ea5872e7a179cee48af8b342b1525a>Microsoft Azure</a></li><ul><li>1.4.1: <a href=#pg-49076824f59c97f04453eaf3b3f6dbae>Account Setup</a></li><li>1.4.2: <a href=#pg-2272d5c519c02840f7ed49134a7bb4c7>Terraform Backend</a></li><li>1.4.3: <a href=#pg-1c163698e334dd4401ddcdc57074abd9>OpenID Connect</a></li></ul><li>1.5: <a href=#pg-678e43bc7d6fc02e9e59fd22f3421ddb>Google Cloud Platform (GCP)</a></li><ul><li>1.5.1: <a href=#pg-0d86a12c9c001657acfee1fd19a167bc>Account Setup</a></li><li>1.5.2: <a href=#pg-42e62deeade8d37e64b220e78934a681>Terraform Backend</a></li><li>1.5.3: <a href=#pg-9bcd402fa4d9352b990c1fe87d0421ce>OpenID Connect</a></li></ul></ul><li>2: <a href=#pg-7e8e3f1008421ab9c045483af58da1c1>Data Ingestion & Data Lake</a></li><ul><li>2.1: <a href=#pg-c2113c28ba0a1e1c4c6ea99c61ab177b>AWS | Data Ingestion & Data Lake</a></li></ul></ul><div class=content><p>Welcome to OpenVERS&rsquo; official documentation hub for our Data Platform! Whether you&rsquo;re a data scientist, engineer, architect, or just getting started, this resource is designed to help you navigate every aspect of our platform—from setup and integrations to advanced analytics and troubleshooting.</p><p>We aim to provide clear, step-by-step guides that help you get started quickly, troubleshoot issues, and maximize the existing platform & cloud provider capabilities. The documentation empowers users to work efficiently, saving time and reducing the learning curve. It&rsquo;s also structured to be intuitive, allowing you to easily find relevant information—whether you&rsquo;re configuring data pipelines, securing your environment, or exploring visualization tools. Furthermore, it helps you stay compliant with security and regulatory standards through comprehensive guides on security and governance. Ultimately, this documentation ensures you have the knowledge and support to fully leverage modern practices, enabling you to solve data challenges and drive innovation confidently.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-be9f1ecae30cf02a3da539a6993d5d2d>1 - Cloud Setup</h1><div class=lead>Essential steps for getting started with necessary platforms and top Cloud providers.</div><h2 id=getting-started>Getting Started<a class=td-heading-self-link href=#getting-started aria-label="Heading self-link"></a></h2><p>In today’s rapidly evolving technology landscape, a proper setup using platform favorites like <a href=https://github.com/>GitHub</a>, <a href=https://www.terraform.io/>Terraform.io</a>, and top cloud providers like <a href=https://aws.amazon.com/>Amazon Web Services (AWS)</a>, <a href=https://azure.microsoft.com/>Microsoft Azure</a>, and <a href=https://cloud.google.com/>Google Cloud Platform (GCP)</a> is essential for meeting the demands of modern infrastructure, development, and data needs. These tools work together to enable scalable, secure, and efficient cloud environments, facilitating everything from code management to automated infrastructure provisioning.</p><h2 id=importance>Importance<a class=td-heading-self-link href=#importance aria-label="Heading self-link"></a></h2><p>A proper setup is crucial for several reasons. Firstly, <strong>scalability</strong> is paramount; modern infrastructure must adapt to fluctuating demands. Tools like <a href=https://www.terraform.io/>Terraform</a> combined with cloud platforms such as <a href=https://aws.amazon.com/autoscaling/>AWS</a>, <a href=https://azure.microsoft.com/en-us/features/autoscale/>Azure</a>, or <a href=https://cloud.google.com/compute/docs/autoscaler/>GCP</a> enable automatic resource scaling based on workload, ensuring performance and cost-efficiency. Secondly, robust <strong>security</strong> is non-negotiable. A correct setup implements security best practices like <a href=https://csrc.nist.gov/Projects/role-based-access-control>role-based access control (RBAC)</a>, encryption (e.g., using services like <a href=https://aws.amazon.com/kms/>AWS KMS</a> or <a href=https://azure.microsoft.com/en-us/services/key-vault/>Azure Key Vault</a>), and comprehensive <a href=https://cloud.google.com/logging/docs/audit/>audit logs</a> to protect sensitive data, further enhanced by cloud-native security features.</p><p>Furthermore, <strong>automation and efficiency</strong> are significantly boosted. Infrastructure changes can be automated, reducing manual configuration errors and accelerating deployment cycles. Integrating <a href=https://github.com/>GitHub</a> with <a href=https://github.com/features/actions>CI/CD pipelines</a> automates testing, builds, and deployments, allowing for rapid iteration without sacrificing quality. This leads to better <strong>cost optimization</strong>, as properly configured cloud platforms help avoid over-provisioning, enabling teams to manage resources efficiently (see <a href=https://aws.amazon.com/cost-management/>AWS Cost Management</a>, <a href=https://azure.microsoft.com/en-us/services/cost-management/>Azure Cost Management</a>, <a href=https://cloud.google.com/cost-management/>GCP Cost Management</a>). Finally, using <a href=https://www.redhat.com/en/topics/automation/what-is-infrastructure-as-code-iac>Infrastructure as Code (IaC)</a> tools like Terraform with a common repository like GitHub ensures <strong>consistency across environments</strong> (development, staging, production), minimizing deployment errors and enhancing reliability.</p><h2 id=summary>Summary<a class=td-heading-self-link href=#summary aria-label="Heading self-link"></a></h2><p>A thought-out setup is critical to meeting the challenges of modern infrastructure and development. It enables organizations to move faster, stay secure, and scale effortlessly, all while keeping costs under control and fostering innovation. Continue reading in this section to learn about getting setup to make full use of these favorited services, platforms and cloud providers.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-913dc8e708929c01dde440b8c83e37e5>1.1 - Github</h1><div class=lead>Setting up GitHub is essential for managing code version control, enabling seamless collaboration, and integrating with CI/CD pipelines for efficient development workflows.</div><p>Having a GitHub organization is crucial for Data Practioners and Businesses because it centralizes and manages code repositories under one cohesive structure. It allows for better collaboration by giving multiple users access to shared projects while maintaining control over permissions and visibility. Instead of individual repositories scattered across personal accounts, a Github Organization allows projects to be consolidated in a secure and professional environment. This structure is essential for large projects where multiple contributors, such as developers, designers, and project managers, need to collaborate efficiently while ensuring that intellectual property and source code are well-organized and protected.</p><p>Additionally, a GitHub organization simplifies permission management and enables role-based access control. You can assign specific roles to team members—like admin, maintainer, or contributor—ensuring that only authorized personnel can make changes to critical repositories or infrastructure. This is particularly important for scaling teams, where keeping track of individual contributions and access becomes more complex. The organization also integrates seamlessly with CI/CD pipelines, security tools, and other DevOps practices, ensuring consistent development practices across teams. Overall, a GitHub organization fosters better collaboration, security, and project management, which is critical for the success of modern development efforts.</p><h1 id=getting-started>Getting Started<a class=td-heading-self-link href=#getting-started aria-label="Heading self-link"></a></h1><p>Creating a Github Organiziation can be done free of charge, and only requires that a Github account has already been created. If you&rsquo;re new to Github, then you can register <a href=https://docs.github.com/en/get-started/start-your-journey/creating-an-account-on-github>here</a>. When ready, follow these instructions for <a href=https://docs.github.com/en/organizations/collaborating-with-groups-in-organizations/creating-a-new-organization-from-scratch>Creating a New Organization from Scratch</a>.</p><h2 id=install-cli>Install CLI<a class=td-heading-self-link href=#install-cli aria-label="Heading self-link"></a></h2><p>The <strong>GitHub CLI (Command-Line Interface)</strong> allows developers to interact with GitHub directly from the terminal, streamlining key workflows such as managing repositories, issues, and pull requests, as well as triggering CI/CD pipelines via GitHub Actions. With the CLI, you can authenticate, review code, merge pull requests, manage project settings, and gain insights into repositories—all without switching to the web interface.</p><p>Please visit the <a href="https://github.com/cli/cli?tab=readme-ov-file#installation">Official Github CLI Installing Instructions</a> to review the install steps. Github (both the platform and the CLI) also require the standalone <code>git</code> cli to be installed. If you haven&rsquo;t already done so, please also follow <a href=https://github.com/git-guides/install-git>Github&rsquo;s git Install Instructions</a> to install the git CLI.</p><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Login to Github Through CLI</span>
</span></span><span style=display:flex><span>  gh auth login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># [Optional] rerfresh login needed sometimes</span>
</span></span><span style=display:flex><span>  gh auth refresh -h github.com -s user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>#https://docs.github.com/en/rest/users/users?apiVersion=2022-11-28#get-the-authenticated-user</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>GH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gh api <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -H <span style=color:#4e9a06>&#34;Accept: application/vnd.github+json&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -H <span style=color:#4e9a06>&#34;X-GitHub-Api-Version: 2022-11-28&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    /user <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --jq <span style=color:#4e9a06>&#34;.login&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>GH_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gh api <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -H <span style=color:#4e9a06>&#34;Accept: application/vnd.github+json&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -H <span style=color:#4e9a06>&#34;X-GitHub-Api-Version: 2022-11-28&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    /user/emails <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --jq <span style=color:#4e9a06>&#34;.[0].email&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  git config global.user <span style=color:#000>$GH_USER</span>
</span></span><span style=display:flex><span>  git config global.email <span style=color:#000>$GH_EMAIL</span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=repository>Repository<a class=td-heading-self-link href=#repository aria-label="Heading self-link"></a></h2><p>A source code repository to store your code base isn&rsquo;t a requirement to starting any new project right off the hop, but is a requirement when the project begins to scale and needs more team work involvement, or the project lifecycle is moving from POC into a MVP life stage. Creating and using Git repositories is likely common knowledge to many, but here&rsquo;s a quick refresher on creating a repository with Github.</p><ul class="nav nav-tabs justify-content-end" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
Web</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=shell aria-controls=tabs-01-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><pre tabindex=0><code>  Go to Github&#39;s Adding locally hosted code to Github for more details on how to start.
  https://docs.github.com/en/migrations/importing-source-code/using-the-command-line-to-import-source-code/adding-locally-hosted-code-to-github#initializing-a-git-repository
  </code></pre></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create a new Python package scaffolding</span>
</span></span><span style=display:flex><span>  pip install --upgrade pyscaffold
</span></span><span style=display:flex><span>  putup example_project
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Add a README to begin describing what is the purpose of the project</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>cd</span> example_project
</span></span><span style=display:flex><span>  cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; README.md
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    # Example Project
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    This is a repository to store the code base for this example project
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    ## Purpose
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    Example learning materials
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create the new github repository - all gh CLI to initialize local git</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># https://docs.github.com/en/github-cli/github-cli/quickstart#creating-a-repository</span>
</span></span><span style=display:flex><span>  gh auth refresh -h github.com -s user
</span></span><span style=display:flex><span>  gh repo create
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=environments>Environments<a class=td-heading-self-link href=#environments aria-label="Heading self-link"></a></h2><p>Github Environments are useful components within the Github Organization for isolating different working areas within CI/CD Deployment pipelines (or Github Action Workflows). Some common use case where environments become necessary is restricting Github Actions from being able to spin up costly cloud resources, or executing long running workflows which can deplete your Github Organization&rsquo;s free minutes. At OpenVERS, we recommend creating one Github Organization Environment to start</p><blockquote><p><strong>Production</strong> This environment will be locked to only admins being able to sign-off on Github Action Workflows
running. This is the protective layer in CI/CD where we will allow for infrastructure to be spun up - making
sure that human interaction is required.</p></blockquote><ul class="nav nav-tabs justify-content-end" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
Web</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=shell aria-controls=tabs-02-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><pre tabindex=0><code>  Go to Github&#39;s Creating an Environment for more details on how to start.
  https://docs.github.com/en/actions/managing-workflow-runs-and-deployments/managing-deployments/managing-environments-for-deployment#creating-an-environment
  </code></pre></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Ensure current working directory is set in correct repo</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>cd</span> example_project
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create environment</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>GH_REPO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gh repo view --json name -q <span style=color:#4e9a06>&#34;.name&#34;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>GH_ORG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gh org list --limit 1<span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Assumes only one organization owned by GH User</span>
</span></span><span style=display:flex><span>  gh api --method PUT <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    -H <span style=color:#4e9a06>&#34;Accept: application/vnd.github+json&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    repos/<span style=color:#000>$GH_ORG</span>/<span style=color:#000>$GH_REPO</span>/environments/production
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h3 id=secrets>Secrets<a class=td-heading-self-link href=#secrets aria-label="Heading self-link"></a></h3><p>GitHub Secrets are vital for securing sensitive information like API keys, access tokens, passwords, and other credentials used in automated workflows, such as continuous integration (CI) and continuous deployment (CD). By storing these values in encrypted environments within repositories or GitHub Actions, secrets help protect against accidental exposure of sensitive data in code or public logs. This is crucial for maintaining security, as it prevents unauthorized access to critical infrastructure or services. Additionally, GitHub Secrets enable teams to manage and update credentials securely without embedding them directly in codebases, ensuring that workflows remain safe, flexible, and compliant with best security practices.</p><blockquote><p>Sensitive credentials require high security scrutiny because their exposure can lead to unauthorized access,
data breaches, and compromised systems, putting critical assets and confidential information at risk. Follow
Github&rsquo;s <a href=https://docs.github.com/en/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions>Security Hardening Best Practices</a> for more details. OpenVERS guides utilize OpenID Connect
where possible as the &ldquo;Best in Class&rdquo; security hardening practice.</p></blockquote><ul class="nav nav-tabs justify-content-end" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab aria-controls=tabs-03-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab aria-controls=tabs-03-01 aria-selected=true>
Web</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab data-td-tp-persist=shell aria-controls=tabs-03-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-pane fade" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><pre tabindex=0><code>  Go to Github&#39;s Using Secrets in Github Actions for more details on how to configuring secrets.
  https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-an-organization
  </code></pre></div><div class="tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create organization secret</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># https://cli.github.com/manual/gh_secret_set</span>
</span></span><span style=display:flex><span>  gh auth refresh -h github.com -s user
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>GH_ORG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gh org list --limit 1<span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Assumes only one organization owned by GH User</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Paste secret value for the current repository in an interactive prompt</span>
</span></span><span style=display:flex><span>  gh secret <span style=color:#204a87>set</span> EXAMPLE_SECRET --org <span style=color:#000>$GH_ORG</span> --visibility all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h3 id=variables>Variables<a class=td-heading-self-link href=#variables aria-label="Heading self-link"></a></h3><p>GitHub Variables are crucial for creating dynamic and reusable workflows in GitHub Actions, allowing developers to manage configuration values that are frequently used across different workflows or environments. Unlike secrets, which are specifically designed to protect sensitive information, variables store non-sensitive data such as environment settings, deployment configurations, or feature flags. They improve workflow flexibility by centralizing and standardizing values that may change depending on the environment (e.g., development, staging, production), making workflows easier to maintain and scale. By using GitHub Variables, teams can avoid hardcoding values in workflows, reducing duplication and minimizing the risk of errors when updating configurations across multiple workflows. This improves efficiency, consistency, and maintainability in continuous integration and deployment pipelines.</p><ul class="nav nav-tabs justify-content-end" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab aria-controls=tabs-04-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab aria-controls=tabs-04-01 aria-selected=true>
Web</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=shell aria-controls=tabs-04-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-pane fade" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><pre tabindex=0><code>  Go to Github&#39;s Using Secrets in Github Actions for more details on how to configuring secrets.
  https://docs.github.com/en/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-an-organization
  </code></pre></div><div class="tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create organization secret</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># https://cli.github.com/manual/gh_secret_set</span>
</span></span><span style=display:flex><span>  gh auth refresh -h github.com -s user
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>GH_ORG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gh org list --limit 1<span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Assumes only one organization owned by GH User</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Paste secret value for the current repository in an interactive prompt</span>
</span></span><span style=display:flex><span>  gh variable <span style=color:#204a87>set</span> EXAMPLE_SECRET --org <span style=color:#000>$GH_ORG</span> --visibility all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-48173e7a425474aab8947f97578b3238>1.2 - Terraform.io</h1><div class=lead>Terraform.io platform service enables teams to collaborate on cloud agnostic infrastructure as code (IaC) workspaces.</div><p>Terraform is a powerful infrastructure-as-code (IaC) tool that enables users to automate the provisioning, management, and scaling of infrastructure across various cloud providers such as AWS, Azure, and Google Cloud, as well as on-premise environments. With its declarative configuration language, Terraform allows users to define infrastructure in reusable code that can be versioned and shared, ensuring consistency and reducing manual errors. One of its key capabilities is the use of state files, which track the infrastructure&rsquo;s current state, enabling Terraform to apply only necessary changes when updating resources. Terraform’s provider-agnostic architecture supports a wide range of services, making it ideal for multi-cloud strategies and hybrid infrastructures. It also integrates seamlessly with CI/CD pipelines, enabling teams to automate infrastructure updates, enforce security policies, and collaborate effectively.</p><h1 id=getting-started>Getting Started<a class=td-heading-self-link href=#getting-started aria-label="Heading self-link"></a></h1><p>Creating a Hashicorp Terraform account can be done free of charge, and only requies that a Github account has already been created. More details about registering with Github can be found in our <a href=docs/cloud_setup/github>Github Setup Instructions</a>. When ready, follow these instructions for <a href="https://app.terraform.io/public/signup/account?product_intent=terraform">Create a New Hashicorp Terraform Account</a>.</p><h2 id=install-cli>Install CLI<a class=td-heading-self-link href=#install-cli aria-label="Heading self-link"></a></h2><p>The <strong>Terraform CLI</strong> is the primary tool for building infrastructure on cloud platforms. It allows users to define, plan, and apply infrastructure changes across various cloud providers and on-premise systems. The CLI also helps manage state files, configure variables, and track dependencies between resources, ensuring efficient, consistent, and automated infrastructure management.</p><p>Please visit the <a href=https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli#install-terraform>Official Terraform CLI Installing Instructions</a> to review the install steps. For the purposes of this example, please make sure Docker Engine in installed locally (follow install instructions at <a href=https://developer.hashicorp.com/terraform/tutorials/docker-get-started/install-cli#quick-start-tutorial>Terraform/Docker Quick Start</a>).</p><h2 id=infrastructure-as-code-iac>Infrastructure as Code (IaC)<a class=td-heading-self-link href=#infrastructure-as-code-iac aria-label="Heading self-link"></a></h2><p>Terraform configuration is a declarative way to define and manage infrastructure using human-readable configuration files, typically written in HashiCorp Configuration Language (HCL) or JSON. Once the configuration is written, Terraform can automatically provision and manage infrastructure based on these definitions, ensuring consistency across environments while reducing manual intervention and errors.</p><p>Here&rsquo;s a short example on connecting with Terraform.io to create a new workspace for our terraform infracture code, and writing a short terraform example with Docker to spin up an NGINX server. After the server has been spun up locally, we then destroy the resources as good practice for any example use cases.</p><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create new terraform.io workspace</span>
</span></span><span style=display:flex><span>  terraform login
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>TF_WORKSPACE</span><span style=color:#ce5c00;font-weight:700>=</span>example-workspace
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>TF_TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>cat <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    /home/server/.terraform.d/credentials.tfrc.json <span style=color:#000;font-weight:700>|</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    jq -r <span style=color:#4e9a06>&#39;.[&#34;credentials&#34;][&#34;app.terraform.io&#34;][&#34;token&#34;]&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>export</span> <span style=color:#000>TF_ORGANIZATION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --header <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TF_TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --header <span style=color:#4e9a06>&#34;Content-Type: application/vnd.api+json&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --request GET <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    https://app.terraform.io/api/v2/organizations <span style=color:#000;font-weight:700>|</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    jq -r <span style=color:#4e9a06>&#39;.[&#34;data&#34;][0][&#34;id&#34;]&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># https://developer.hashicorp.com/terraform/cloud-docs/api-docs/organizations</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  terraform workspace new <span style=color:#000>$TF_WORKSPACE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create example exercise path</span>
</span></span><span style=display:flex><span>  mkdir <span style=color:#000>$TF_WORKSPACE</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>cd</span> <span style=color:#000>$TF_WORKSPACE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cat <span style=color:#ce5c00;font-weight:700>&lt;&lt;&lt;</span>EOT &gt; maint.tf
</span></span><span style=display:flex><span>    terraform <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      required_providers <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>docker</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87>source</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;kreuzwerker/docker&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;~&gt; 3.0.1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      backend <span style=color:#4e9a06>&#34;remote&#34;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># The name of your Terraform Cloud organization.</span>
</span></span><span style=display:flex><span>        <span style=color:#000>organization</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TF_ORGANIZATION</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic># The name of the Terraform Cloud workspace to store Terraform state files in.</span>
</span></span><span style=display:flex><span>        workspaces <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TF_WORKSPACE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    provider <span style=color:#4e9a06>&#34;docker&#34;</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    resource <span style=color:#4e9a06>&#34;docker_image&#34;</span> <span style=color:#4e9a06>&#34;nginx&#34;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>name</span>         <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;nginx&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#000>keep_locally</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    resource <span style=color:#4e9a06>&#34;docker_container&#34;</span> <span style=color:#4e9a06>&#34;nginx&#34;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>image</span> <span style=color:#ce5c00;font-weight:700>=</span> docker_image.nginx.image_id
</span></span><span style=display:flex><span>      <span style=color:#000>name</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tutorial&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      ports <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>internal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>80</span>
</span></span><span style=display:flex><span>        <span style=color:#000>external</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>8000</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  EOT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Spin up example tf infrastructure</span>
</span></span><span style=display:flex><span>  terraform init
</span></span><span style=display:flex><span>  terraform plan
</span></span><span style=display:flex><span>  terraform apply --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Spin down example tf infrastructure</span>
</span></span><span style=display:flex><span>  terraform destroy --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><p>Proper Terraform configurations are modular, allowing developers to reuse code and organize resources logically. It can include variables for flexibility, resource blocks to define specific infrastructure components, and modules for grouping related resources. OpenVERS endorses <a href=https://terragrunt.gruntwork.io/docs/features/keep-your-terraform-code-dry/>Don&rsquo;t Repeat Yourself (DRY)</a> principals when building infrastructure, and follows the module pattern outlined by <a href=https://developer.hashicorp.com/terraform/tutorials/modules/module-create#module-structure>Hashicorp Module Structure</a>.</p><pre tabindex=0><code>
.
├──modules
│  ├──example_module_A
│  │  ├──resources.tf
│  │  ├──variables.tf
│  │  └──output.tf
│  └──example_module_A
│     ├──resources.tf
│     ├──variables.tf
│     └──output.tf
│
├──test
│  ├──main.tf
│  ├──variables.tf
│  ├──output.tf
│  └──terraform.tfvars
│
├──README.md
├──resources.tf
├──variables.tf
└──output.tf
</code></pre><h2 id=orchestration>Orchestration<a class=td-heading-self-link href=#orchestration aria-label="Heading self-link"></a></h2><p>Terraform orchestration becomes even more powerful and streamlined, particularly for managing complex, multi-environment, or multi-account infrastructures. Terragrunt is a wrapper around Terraform that simplifies the orchestration of infrastructure by automating repetitive tasks and enforcing best practices. It helps manage and maintain consistent configurations across multiple Terraform modules, handling dependencies and remote state management more efficiently.</p><p>By using Terragrunt, teams can reduce boilerplate code, avoid duplication, and more easily orchestrate large infrastructure deployments across environments like development, staging, and production. It automatically handles resource dependencies, ensuring that Terraform runs in the right order and across different cloud environments or accounts. Terragrunt also allows for centralized configuration, reducing the manual effort of updating individual environments, making it easier to manage infrastructure changes at scale. This enhanced orchestration ensures smoother, more consistent infrastructure provisioning and management across various environments and teams.</p><p>Please visit the <a href=https://terragrunt.gruntwork.io/docs/getting-started/install/#install-via-a-package-manager>Official Terragrunt CLI Installing Instructions</a> to review the install steps. Below is a continuation of the Docker terraform example above where we can use Terragrunt to orchestrate a simple single enviornment configuration deployment for our NGINX server.</p><ul class="nav nav-tabs justify-content-end" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=shell aria-controls=tabs-01-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Enter example exercise path</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>cd</span> <span style=color:#000>$TF_WORKSPACE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Create a terragrunt configuration for our main.tf infrastructure</span>
</span></span><span style=display:flex><span>  cat <span style=color:#ce5c00;font-weight:700>&lt;&lt;&lt;</span>EOT &gt; terragrunt.hcl
</span></span><span style=display:flex><span>    terraform <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>path_relative_from_include</span><span style=color:#000;font-weight:700>()</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/main&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000>inputs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;terrafgrunt-example&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  EOT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Spin up example with terragrunt</span>
</span></span><span style=display:flex><span>  terragrunt init
</span></span><span style=display:flex><span>  terragrunt plan
</span></span><span style=display:flex><span>  terragrunt apply --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Spin down example with terragrunt</span>
</span></span><span style=display:flex><span>  terragrunt destroy --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5b0f2c912434cb90a51bdfe1ef7bda08>1.3 - Amazon Web Services (AWS)</h1><div class=lead>AWS - The premier and longest standing cloud computing platform provided by Amazon.</div><p>AWS (Amazon Web Services) is a comprehensive cloud computing platform provided by Amazon that offers a wide range of services, including computing, storage, databases, analytics, machine learning, and more. AWS allows data practioners to build, deploy, and manage applications and workloads in a flexible, scalable, and secure manner on their cloud platform. When setting up AWS for the first time, security requirements are essential for data practitioners to ensure the confidentiality and integrity their data and applications. Without proper security measures in place, sensitive data can be exposed to unauthorized access, but more dangerous to the hobbyist is the exposure to malicious activities when credentials are compromised. It&rsquo;s crucial to implement security best practices, such as identity and access management (IAM), authentication and authorization controls, and network security to protect against potential threats. By prioritizing security requirements from the outset, data practitioners can prevent common security mistakes such as misconfigured S3 buckets, overly permissive IAM policies, and account credential breaches.</p><h1 id=getting-started>Getting Started<a class=td-heading-self-link href=#getting-started aria-label="Heading self-link"></a></h1><p>The <strong>AWS CLI</strong> tool is a powerful utility that allows users to interact with AWS services from the command line, and enabling them to manage and automate various tasks such as creating/ managing resources or configuring services. Please visit the <a href=https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html>Official AWS CLI Installing Instructions</a> to review the install steps. For additional CLI support for AWS, please also consider downloading/ installing <a href=https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html>AWS SAM CLI</a> for local debugging, and <a href=https://docs.aws.amazon.com/toolkit-for-vscode/latest/userguide/setup-toolkit.html>AWS Toolkit for Visual Studio Code</a> for creating function templates and accelerating build and debug purposes.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-de7870d69afa943e168922a0fd5a7a72>1.3.1 - Account Setup</h1><div class=lead>AWS - New Account Setup with Critical Security Measures Applied as First Priority.</div><h2 id=setup-new-account>Setup New Account<a class=td-heading-self-link href=#setup-new-account aria-label="Heading self-link"></a></h2><p>Creating an AWS account can be done free of charge. More details about registering with AWS can be found at their <a href=https://aws.amazon.com/resources/create-account/>New Account Instructions</a> web page. We also need to keep in mind securing protective measures against our newly created users to protect our resources and data from possible breaches and mailicous actors, and therefore we follow some elementary guidelines documented by AWS for securing new user setup.</p><h3 id=aws-organization>AWS Organization<a class=td-heading-self-link href=#aws-organization aria-label="Heading self-link"></a></h3><p>Enable AWS Organizations following <a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/get-set-up-for-idc.html>Instructions Here</a>. This does not require additional funding, and is a requirement for the next step.</p><h3 id=iam-identity-center>IAM Identity Center<a class=td-heading-self-link href=#iam-identity-center aria-label="Heading self-link"></a></h3><p>Before we begin creating new users, we should enable SSO login into AWS Console for our account. This can be done by <a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/get-set-up-for-idc.html>Enabling IAM Identity Center</a>.</p><ul><li><p><a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/addusers.html#:~:text=To%20add%20a%20user&amp;text=Choose%20Users.,can't%20be%20changed%20later.">Add IAM Identity User</a> to send invite to your root user email</p></li><li><p>Include configuration for <a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/assignusers.html>Multi-Account Permissions AWS Accounts</a> to assign user to newly created AWS Account. Proceed to include the permission sets with pre-defined <strong>AdministratorAccess</strong>.</p></li><li><p>Navigate to Users and send invite via email. Proceed to check invite from email and setup MFA authentication.</p></li></ul><h3 id=cli-access-for-usersdevelopers>CLI Access for Users/Developers<a class=td-heading-self-link href=#cli-access-for-usersdevelopers aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Configure &amp; Login to AWS root account</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># https://docs.aws.amazon.com/signin/latest/userguide/command-line-sign-in.html</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># </span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># SSO session name (Recommended): my-sso</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># SSO start URL [None]: [COPY/PASTE FROM IAM Identity Center -&gt; Settings -&gt; Identity Source -&gt; AWS access portal URL]</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># SSO region [None]: us-east-1</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># SSO registration scopes [None]: sso:account:access</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># CLI profile name [PermissionSet-AWS_Account]: sso-admin</span>
</span></span><span style=display:flex><span>  aws configure sso
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  aws sso login --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><p>Remember! You can always find your IAM Identity Center Access Portal in the CLI after logging in.</p><h2 id=service-principal-programmatic-access>Service Principal (Programmatic Access)<a class=td-heading-self-link href=#service-principal-programmatic-access aria-label="Heading self-link"></a></h2><p>To enable programmatic access to AWS resources, you can create a Service Principal using either:</p><ul><li>An IAM User with programmatic access (requires long-term access keys), or</li><li>An IAM Role, which can be assumed to obtain short-term credentials (no long-term secret required).</li></ul><p>For most automation and service-to-service scenarios, AWS recommends using IAM Roles and short-term credentials. These credentials are generated dynamically and do not require you to manage or rotate long-term secrets.</p><h3 id=programmatic-steps>Programmatic Steps<a class=td-heading-self-link href=#programmatic-steps aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs justify-content-end" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=shell aria-controls=tabs-01-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_SSO_CURRENT_IDENTITY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws sts get-caller-identity <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_SSO_INSTANCE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws sso-admin list-instances <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_SSO_CURRENT_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_CURRENT_IDENTITY</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  jq -r <span style=color:#4e9a06>&#39;.UserId&#39;</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  cut -d<span style=color:#4e9a06>&#39;:&#39;</span> -f2<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_SSO_IDENTITY_STORE_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_INSTANCE</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  jq -r <span style=color:#4e9a06>&#39;.Instances[0].IdentityStoreId&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_SSO_CURRENT_PRINCIPAL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws identitystore list-users <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--identity-store-id <span style=color:#000>$AWS_SSO_IDENTITY_STORE_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--query<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Users&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin <span style=color:#000;font-weight:700>|</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  jq -r --arg user <span style=color:#000>$AWS_SSO_CURRENT_USER</span> <span style=color:#4e9a06>&#39;map(select(.UserName | contains($user)))[0]&#39;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Create a new IAM Identity Center Permission Set</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sso-admin/create-permission-set.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_SSO_PERMISSION_SET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws sso-admin create-permission-set <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --instance-arn <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_INSTANCE</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.Instances[0].InstanceArn&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name <span style=color:#4e9a06>&#34;ExampleCustomViewerPermissionSet&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --description <span style=color:#4e9a06>&#34;Example viewer permissions for my team&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --session-duration <span style=color:#4e9a06>&#34;PT8H&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Attach a Managed Policy</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sso-admin/attach-managed-policy-to-permission-set.html</span>
</span></span><span style=display:flex><span>aws sso-admin attach-managed-policy-to-permission-set <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --instance-arn <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_INSTANCE</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.Instances[0].InstanceArn&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --permission-set-arn <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_PERMISSION_SET</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.PermissionSetArn&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --managed-policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Assign Account Access and Permissions to User</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sso-admin/create-account-assignment.html</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This is for for example purposes as normally you would not</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># assigning yourself permissions as an administrator</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws sso-admin create-account-assignment <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --instance-arn <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_INSTANCE</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.Instances[0].InstanceArn&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --target-type ACCOUNT <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --target-id <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_CURRENT_IDENTITY</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.AccountId&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --principal-type USER <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --principal-id <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_CURRENT_PRINCIPAL</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.Arn&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --permission-set-arn <span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$AWS_SSO_PERMISSION_SET</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.PermissionSetArn&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h3 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h3><p>To assign permissions to SSO-enabled users in AWS, use AWS IAM Identity Center (formerly AWS SSO). This approach is recommended for organizations using SSO, as it centralizes access management and leverages short-term credentials for improved security.</p><p>Start by <a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/howtocreatepermissionset.html>Creating a Permission Set</a> - name this new Permission Set <strong>ExampleCustomViewerPermissionSet</strong>, and select the *<em>ViewOnlyAccess</em> <a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/permissionsetcustom.html#permissionsetsampconcept>Managed Policy</a> to grant this Permission set with view only access.</p><p>Next, <a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/user-assignments.html>Assigning Users</a> to this Permission Set and AWS Account combination to allow users to sign-on assuming these permissions through SSO login. For more information, see <a href=https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html>User Guide for AWS IAM Identity Center</a> or</p><ul><li><a href=https://docs.aws.amazon.com/singlesignon/latest/APIReference/API_CreateAccountAssignment.html>Create Account Assignment</a></li><li><a href=https://docs.aws.amazon.com/singlesignon/latest/APIReference/API_CreatePermissionSet.html>Create Permission Sets</a></li><li><a href=https://docs.aws.amazon.com/singlesignon/latest/APIReference/API_AttachManagedPolicyToPermissionSet.html>Attach Managed Policies to Permission Sets</a></li></ul><h2 id=legacy-account-setup>Legacy Account Setup<a class=td-heading-self-link href=#legacy-account-setup aria-label="Heading self-link"></a></h2><p>If we do not want to enable AWS Identity Center, and utilize SSO for CLI authentication, then we can also restrict AWS IAM Account access to developer machines only. These steps are also useful for creating Service Accounts required by AWS Services (not to be used by developers).</p><h3 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs justify-content-end" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=shell aria-controls=tabs-02-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li><li class=nav-item><button class=nav-link id=tabs-02-03-tab data-bs-toggle=tab data-bs-target=#tabs-02-03 role=tab data-td-tp-persist=hcl aria-controls=tabs-02-03 aria-selected=false>
<span style=vertical-align:middle><img src=https://cdn.simpleicons.org/terraform/5835CC alt="Terraform icon" style=height:1em;vertical-align:middle;margin-right:.3em></span>
Terraform</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_ACCOUNT</span><span style=color:#ce5c00;font-weight:700>=[</span>INSERT AWS ACCOUNT ID<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>DEVELOPER_IP_CIDR</span><span style=color:#ce5c00;font-weight:700>=[</span>INSERT IP CIDR<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**1. <span style=color:#ce5c00;font-weight:700>(</span>Optional<span style=color:#ce5c00;font-weight:700>)</span> Create an IP Restriction Policy**
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat &gt; ip-restrict-policy.json <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Deny&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;NotAction&#34;: &#34;iam:*&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Resource&#34;: &#34;*&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;NotIpAddress&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;aws:SourceIp&#34;: &#34;${DEVELOPER_IP_CIDR}&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Create the policy:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam create-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-name IPRestrictPolicy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-document file://ip-restrict-policy.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**2. Create the Service Principal <span style=color:#ce5c00;font-weight:700>(</span>IAM User<span style=color:#ce5c00;font-weight:700>)</span>**
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam create-user --user-name my-example-legacy-principal
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**3. Attach the IP Restriction Policy <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> created<span style=color:#ce5c00;font-weight:700>)</span> and IAMFullAccess**
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam attach-user-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --user-name my-example-legacy-principal <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn arn:aws:iam::<span style=color:#4e9a06>${</span><span style=color:#000>AWS_ACCOUNT</span><span style=color:#4e9a06>}</span>:policy/IAMFullAccess
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># If you created the custom IP restriction policy, attach it as well:</span>
</span></span><span style=display:flex><span>aws iam attach-user-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --user-name my-example-legacy-principal <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn arn:aws:iam::<span style=color:#4e9a06>${</span><span style=color:#000>AWS_ACCOUNT</span><span style=color:#4e9a06>}</span>:policy/IPRestrictPolicy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**4. Create Access Keys <span style=color:#204a87;font-weight:700>for</span> CLI Use**
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam create-access-key --user-name my-example-legacy-principal
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Save the AccessKeyId and SecretAccessKey securely for CLI configuration.</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>**1. Detach Policies from the User**
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam detach-user-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --user-name my-example-legacy-principal <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn arn:aws:iam::<span style=color:#4e9a06>${</span><span style=color:#000>AWS_ACCOUNT</span><span style=color:#4e9a06>}</span>:policy/IAMFullAccess
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam detach-user-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --user-name my-example-legacy-principal <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn arn:aws:iam::<span style=color:#4e9a06>${</span><span style=color:#000>AWS_ACCOUNT</span><span style=color:#4e9a06>}</span>:policy/IPRestrictPolicy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**3. Delete the User**
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam delete-user --user-name my-example-legacy-principal
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>**4. <span style=color:#ce5c00;font-weight:700>(</span>Optional<span style=color:#ce5c00;font-weight:700>)</span> Delete the Custom Policy**
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam delete-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn arn:aws:iam::<span style=color:#4e9a06>${</span><span style=color:#000>AWS_ACCOUNT</span><span style=color:#4e9a06>}</span>:policy/IPRestrictPolicy</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-03 role=tabpanel aria-labelled-by=tabs-02-03-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HCL data-lang=HCL><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## ---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## AWS PROVIDER
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Configures the AWS provider with CLI Configured Authentication.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## ---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>provider</span> <span style=color:#4e9a06>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  alias</span>   <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;accountgen&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## AWS SERVICE ACCOUNT MODULE
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## This module provisions an AWS service account along with associated roles and security groups.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Parameters:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `service_account_name`: The display name of the new AWS Service Account.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `service_account_path`: The new AWS Service Account IAM Path.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `roles_list`: List of IAM roles to bing to new AWS Service Account.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Providers:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `aws.accountgen`: Alias for the AWS provider for generating service accounts.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>module</span> <span style=color:#4e9a06>&#34;aws_service_account&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  source</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;github.com/sim-parables/terraform-aws-service-account&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  service_account_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;legacy-service-account&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>  service_account_path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;example&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  providers</span> <span style=color:#ce5c00;font-weight:700>=</span> {
</span></span><span style=display:flex><span><span style=color:#000>    aws.accountgen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>aws</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>accountgen</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div><h3 id=console-steps-1>Console Steps<a class=td-heading-self-link href=#console-steps-1 aria-label="Heading self-link"></a></h3><h4 id=security-policy>Security Policy<a class=td-heading-self-link href=#security-policy aria-label="Heading self-link"></a></h4><p>Create a new Policy with <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_examples_aws_deny-ip.html>IP Restrictions</a> so only users in our security group can interact with AWS. This is helpful incase our security tokens are compromised, so even with unauthorized use malicuous actors still wont be able to access our AWS account on another IP address.</p><h4 id=iam-group>IAM Group<a class=td-heading-self-link href=#iam-group aria-label="Heading self-link"></a></h4><p>Create a <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups_create.html>New IAM Group</a> which we can bind the IP Whitelist policy above to.</p><h4 id=iam-user>IAM User<a class=td-heading-self-link href=#iam-user aria-label="Heading self-link"></a></h4><p>Create a <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_console>New IAM User</a> <strong>Without</strong> access to AWS Management Console - this user should only be able to access AWS through CLI.</p><ul><li><p><a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_change-permissions.html#users_change_permissions-add-console>Add User</a> to the the new IAM Group to bind the IP Whitelist policy</p></li><li><p>Add the <code>IAMFullAccess</code> role to this user&rsquo;s <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_change-permissions.html#users_change_permissions-add-console>Permissions</a></p></li><li><p>Create a <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey>CLI Access Credentials</a>, and don&rsquo;t leave page until the Shared Credentials have been completed in the following steps</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3e4fabc8274bcec82d993873a23131d2>1.3.2 - Terraform Backend</h1><div class=lead>AWS - Optional Configurations When Not Using Terraform.io Workspace Backends.</div><h1 id=terrafrom-backend-with-aws>Terrafrom Backend with AWS<a class=td-heading-self-link href=#terrafrom-backend-with-aws aria-label="Heading self-link"></a></h1><p>Using AWS as the backend for Terraform state is another versatile option for managing infrastructure as code. By storing Terraform state in an AWS S3 bucket, teams can take advantage of AWS&rsquo;s robust security features, such as encryption at rest and in transit, access controls, and versioning. Additionally, AWS S3 provides a highly durable and available storage solution, ensuring that Terraform state is always accessible and up-to-date. Furthermore, by using AWS as the backend, teams can also leverage AWS IAM to manage access to the Terraform state, allowing for fine-grained control over who can read and write to the state file. This setup also enables teams to use AWS services such as AWS Lambda and AWS CloudWatch to automate and monitor their Terraform workflows, providing a seamless and integrated experience for managing infrastructure as code.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p ~/development/test/example_aws_tf_backend
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_aws_tf_backend
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Setting</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_TERRAFORM_S3_BUCKET</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 4<span style=color:#204a87;font-weight:700>)</span>-example-tf-state-bucket
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_TERRAFORM_S3_BUCKET_PATH</span><span style=color:#ce5c00;font-weight:700>=</span>sandbox/terraform.tfstate
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_TERRAFORM_DYNAMODB_TABLE</span><span style=color:#ce5c00;font-weight:700>=</span>sandox_terraform_tfstate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Login to AWS root account</span>
</span></span><span style=display:flex><span>aws sso login --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create an S3 Bucket for Terraform State</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3api/create-bucket.html</span>
</span></span><span style=display:flex><span>aws s3api create-bucket <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --acl private <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --bucket <span style=color:#000>$AWS_TERRAFORM_S3_BUCKET</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --region us-east-1 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a DynamoDB Table for Terraform State</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/dynamodb/create-table.html</span>
</span></span><span style=display:flex><span>aws dynamodb create-table <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --table-name <span style=color:#000>$AWS_TERRAFORM_DYNAMODB_TABLE</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --attribute-definitions <span style=color:#000>AttributeName</span><span style=color:#ce5c00;font-weight:700>=</span>LockID,AttributeType<span style=color:#ce5c00;font-weight:700>=</span>S <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --key-schema <span style=color:#000>AttributeName</span><span style=color:#ce5c00;font-weight:700>=</span>LockID,KeyType<span style=color:#ce5c00;font-weight:700>=</span>HASH <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --provisioned-throughput <span style=color:#000>ReadCapacityUnits</span><span style=color:#ce5c00;font-weight:700>=</span>5,WriteCapacityUnits<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Get Caller Identity ARN</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/get-caller-identity.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_TERRAFORM_IAM_USER_ARN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws sts get-caller-identity <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --query <span style=color:#4e9a06>&#39;Arn&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --output text <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create IAM Policy for Terraform Backend Auth</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-policy.html</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; aws_sts_sandbox_policy_document.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Sid&#34;: &#34;SandboxTerraformBackendS3BucketPermissions&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Action&#34;: &#34;s3:ListBucket&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Resource&#34;: &#34;arn:aws:s3:::$AWS_TERRAFORM_S3_BUCKET&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Sid&#34;: &#34;SandboxTerraformBackendS3BlobPermissions&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Action&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;s3:GetObject&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;s3:PutObject&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;s3:DeleteObject&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      ],
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Resource&#34;: &#34;arn:aws:s3:::$AWS_TERRAFORM_S3_BUCKET/$AWS_TERRAFORM_S3_BUCKET_PATH&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Sid&#34;: &#34;SandboxTerraformBackendDynamoDBTablePermissions&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Action&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;dynamodb:DescribeTable&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;dynamodb:GetItem&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;dynamodb:PutItem&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;dynamodb:DeleteItem&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      ],
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Resource&#34;: &#34;arn:aws:dynamodb:*:*:table/$AWS_TERRAFORM_DYNAMODB_TABLE&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create IAM Trust Policy for IAM Role</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-policy.html</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; aws_sts_sandbox_role_trust_policy_document.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Sid&#34;: &#34;SandboxTerraformTrustPolicy&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;AWS&#34;: &#34;$AWS_TERRAFORM_IAM_USER_ARN&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-policy.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_TERRAFORM_IAM_POLICY_ARN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws iam create-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-name example-tf-sandbox-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-document file://aws_sts_sandbox_policy_document.json <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --query <span style=color:#4e9a06>&#39;Policy.Arn&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --output text <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-role.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_TERRAFORM_IAM_ROLE_ARN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws iam create-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-tf-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assume-role-policy-document file://aws_sts_sandbox_role_trust_policy_document.json <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --query <span style=color:#4e9a06>&#39;Role.Arn&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --output text <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/attach-role-policy.html</span>
</span></span><span style=display:flex><span>aws iam attach-role-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn <span style=color:#000>$AWS_TERRAFORM_IAM_POLICY_ARN</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-tf-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure Terraform</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; backend.conf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>bucket                       = &#34;$AWS_TERRAFORM_S3_BUCKET&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>key                          = &#34;$AWS_TERRAFORM_S3_BUCKET_PATH&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>region                       = &#34;us-east-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>encrypt                      = true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>dynamodb_table               = &#34;$AWS_TERRAFORM_DYNAMODB_TABLE&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>profile                      = &#34;sso-admin&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>role_arn                     = &#34;$AWS_TERRAFORM_IAM_ROLE_ARN&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>assume_role_duration_seconds = 900
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; terraform.tfvars
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>aws_cli_profile = &#34;sso-admin&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>aws_region      = &#34;us-east-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; variables.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;aws_cli_profile&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;AWS CLI Profile Name&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;aws_region&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;AWS Account Region&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; maint.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>/* AWS S3 managed terraform state - configurations in backend.conf */
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>terraform {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  backend &#34;s3&#34; {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>/* Proxy AWS Provider */
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>provider &#34;aws&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  alias   = &#34;example-sso-cli&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  profile = var.aws_cli_profile
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  region  = var.aws_region
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Test Terraform</span>
</span></span><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span>terraform apply --auto-approve
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure environment variables are set from the Create step</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Tear Down Terraform</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_aws_tf_backend
</span></span><span style=display:flex><span>terraform destroy --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove IAM Roles &amp; Policies</span>
</span></span><span style=display:flex><span>aws iam detach-role-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn <span style=color:#000>$AWS_TERRAFORM_IAM_POLICY_ARN</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-tf-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam delete-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-tf-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam delete-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn <span style=color:#000>$AWS_TERRAFORM_IAM_POLICY_ARN</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove DynamoDB</span>
</span></span><span style=display:flex><span>aws dynamodb delete-table <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --table-name <span style=color:#000>$AWS_TERRAFORM_DYNAMODB_TABLE</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove S3 Versioned Objects &amp; Bucket</span>
</span></span><span style=display:flex><span>aws s3api delete-objects <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --bucket <span style=color:#000>$AWS_TERRAFORM_S3_BUCKET</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --delete <span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>aws s3api list-object-versions <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --bucket <span style=color:#000>$AWS_TERRAFORM_S3_BUCKET</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --output<span style=color:#ce5c00;font-weight:700>=</span>json <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --query<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{Objects: Versions[].{Key:Key,VersionId:VersionId}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws s3api delete-bucket <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --bucket <span style=color:#000>$AWS_TERRAFORM_S3_BUCKET</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><h3 id=create-s3-bucket>Create S3 Bucket<a class=td-heading-self-link href=#create-s3-bucket aria-label="Heading self-link"></a></h3><p>Create a Private <a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/creating-bucket.html>S3 Bucket</a> for Terraform <code>tfstate</code>. This will reduce the chance of sensitive data being committed to source code.</p><h3 id=create-dynamodb-table>Create DynamoDB Table<a class=td-heading-self-link href=#create-dynamodb-table aria-label="Heading self-link"></a></h3><p>Create a new <a href=https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/getting-started-step-1.html>DynamoDB Table</a> in AWS with a Partition Key named <a href=https://developer.hashicorp.com/terraform/language/settings/backends/s3#dynamodb-state-locking>LockID</a>.</p><h3 id=create-iam-policy>Create IAM Policy<a class=td-heading-self-link href=#create-iam-policy aria-label="Heading self-link"></a></h3><p><a href=https://developer.hashicorp.com/terraform/language/settings/backends/s3>Configure Terraform Backend</a> to store <code>tfstate</code> to S3 by creating a new policy for AWS service principals authorized with Terraform.</p><pre tabindex=0><code>   {
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: &#34;s3:ListBucket&#34;,
            &#34;Resource&#34;: &#34;arn:aws:s3:::[INSERT_BUCKET_NAME]&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;s3:GetObject&#34;,
                &#34;s3:PutObject&#34;,
                &#34;s3:DeleteObject&#34;
            ],
            &#34;Resource&#34;: &#34;arn:aws:s3:::[INSERT_BUCKET_NAME]/[INSERT_PATH_KEY]&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;dynamodb:DescribeTable&#34;,
                &#34;dynamodb:GetItem&#34;,
                &#34;dynamodb:PutItem&#34;,
                &#34;dynamodb:DeleteItem&#34;
            ],
            &#34;Resource&#34;: &#34;arn:aws:dynamodb:*:*:table/[INSERT_TABLE_NAME]&#34;
        }
     ]
   }
</code></pre><h3 id=create-iam-role-with-trust-policy>Create IAM Role with Trust Policy<a class=td-heading-self-link href=#create-iam-role-with-trust-policy aria-label="Heading self-link"></a></h3><p>Create a new <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-custom.html>IAM Role with Custom Trust Policy</a> to allow the Identity Center user with SSO access to <a href=https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html>Assume the Role</a> with the above Policy permissions. Make not of the Role ARN for the next step.</p><pre tabindex=0><code>{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;SandboxTerraformTrustPolicy&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;AWS&#34;: &#34;[INSERT_IDENTITY_CENTER_USER_ARN]&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
</code></pre><h3 id=configure-terraform-backend>Configure Terraform Backend<a class=td-heading-self-link href=#configure-terraform-backend aria-label="Heading self-link"></a></h3><p>Utilize <a href=https://developer.hashicorp.com/terraform/language/backend#partial-configuration>Terraform Partial Configuration</a> which may point to a file with the backend configurations stored in a safer location than hard coding into the <code>main.tf</code> file. Write the contents below into a <code>backend.conf</code> file in the parent directory (and make sure to include into .gitignore).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#000>bucket</span>                       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_S3_BUCKET_NAME]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>key</span>                          <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_S3_BUCKET_PATH]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>region</span>                       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;us-east-1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>encrypt</span>                      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span><span style=color:#000>dynamodb_table</span>               <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_DYNAMODB_TABLE_NAME]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>profile</span>                      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;sso-admin&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>role_arn</span>                     <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_IAM_ROLE_ARN]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>assume_role_duration_seconds</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>900</span>
</span></span></code></pre></div><p>Now Terraform will be configured to store all <code>tfstate</code> in AWS S3 and DynamoDB.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span>terraform apply --auto-approve
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1d14e8c6f158f84d87904be72d1a74c4>1.3.3 - OpenID Connect</h1><div class=lead>AWS - Modernized Security for GitOps & CI/CD where Passwords and Credentials are a Thing of the Past.</div><h1 id=openid-connect-configuration-with-github>OpenID Connect Configuration with Github<a class=td-heading-self-link href=#openid-connect-configuration-with-github aria-label="Heading self-link"></a></h1><p>OpenID Connect (OIDC) is an authentication protocol that enables AWS to securely authenticate users and applications without requiring them to store and manage credentials, allowing for seamless integration with identity providers such as Google, Microsoft, Amazon and Github to providing a seamless and highly secure way to manage access to AWS resources.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir ~/development/test/example_aws_oidc
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_aws_oidc
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Setting</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_REPO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;your-github-repo-name&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Login to AWS root account</span>
</span></span><span style=display:flex><span>aws sso login --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create New User</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-user.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_IAM_USER_ARN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws iam create-user <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --user-name <span style=color:#000>$GH_REPO</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --output text <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --query <span style=color:#4e9a06>&#39;User.Arn&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create IAM Identity Provider for Github Actions</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-open-id-connect-provider.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_IAM_IDENTITY_PROVIDER_ARN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws iam create-open-id-connect-provider <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --url <span style=color:#4e9a06>&#34;https://token.actions.githubusercontent.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --client-id-list <span style=color:#4e9a06>&#34;sts.amazonaws.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --thumbprint-list <span style=color:#4e9a06>&#34;1b511abead59c6ce207077c0bf0e0043b1382612&#34;</span> &gt; create-open-id-connect-provider.json <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --query <span style=color:#4e9a06>&#39;OpenIDConnectProviderArn&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --output text <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create IAM Policy for OIDC Access</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-policy.html</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; aws_oid_sandbox_policy_document.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Action&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;iam:GenerateCredentialReport&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;iam:GenerateServiceLastAccessedDetails&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;iam:Get*&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;iam:List*&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;iam:SimulateCustomPolicy&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;iam:SimulatePrincipalPolicy&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      ],
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Resource&#34;: &#34;*&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create IAM Trust Policy for IAM Role</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-policy.html</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; aws_oidc_sandbox_role_trust_policy_document.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;Statement&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;Federated&#34;: &#34;$AWS_IAM_IDENTITY_PROVIDER_ARN&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Condition&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;StringLike&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;token.actions.githubusercontent.com:sub&#34;: &#34;repo:$GH_REPO/*:ref:refs/heads/main&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;ForAllValues:StringEquals&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;token.actions.githubusercontent.com:aud&#34;: &#34;sts.amazonaws.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;token.actions.githubusercontent.com:iss&#34;: &#34;https://token.actions.githubusercontent.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Principal&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;AWS&#34;: &#34;$AWS_IAM_USER_ARN&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Action&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;sts:AssumeRole&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;sts:TagSession&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      ],
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;Condition&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-policy.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_OIDC_IAM_POLICY_ARN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws iam create-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-name example-oidc-sandbox-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-document file://aws_oidc_sandbox_policy_document.json <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --query <span style=color:#4e9a06>&#39;Policy.Arn&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --output text <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-role.html</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AWS_OIDC_IAM_ROLE_ARN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>aws iam create-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-oidc-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assume-role-policy-document file://aws_oidc_sandbox_role_trust_policy_document.json <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --query <span style=color:#4e9a06>&#39;Role.Arn&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --output text <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/attach-role-policy.html</span>
</span></span><span style=display:flex><span>aws iam attach-role-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn <span style=color:#000>$AWS_OIDC_IAM_POLICY_ARN</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-oidc-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove IAM Roles &amp; Policies</span>
</span></span><span style=display:flex><span>aws iam detach-role-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn <span style=color:#000>$AWS_OIDC_IAM_POLICY_ARN</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-oidc-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam delete-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role-name example-oidc-sandbox-role <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam delete-policy <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --policy-arn <span style=color:#000>$AWS_OIDC_IAM_POLICY_ARN</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>aws iam delete-open-id-connect-provider <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --open-id-connect-provider-arn <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --profile<span style=color:#ce5c00;font-weight:700>=</span>sso-admin
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><h3 id=create-github-oidc-iam-account>Create Github OIDC IAM Account<a class=td-heading-self-link href=#create-github-oidc-iam-account aria-label="Heading self-link"></a></h3><p>The <strong>Assume Role</strong> Trust Policies will need to be bound to a specific IAM Account in order to have Github&rsquo;s CICD Action Workflows to both authenticate and assume roles to with enough permissions as required. We will create unique accounts for Read and Write role sets (similar to Terraform&rsquo;s Plan and Apply operations).</p><p>Create a <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_console>New IAM User</a> <strong>Without</strong> access to AWS Management Console - this user should only be able to access AWS through CLI. We&rsquo;ll repeat this step twice for the following accounts</p><ul><li>github-cicd-service-principal-read</li><li>github-cicd-service-principal-readwrite</li></ul><h3 id=add-identity-provider>Add Identity Provider<a class=td-heading-self-link href=#add-identity-provider aria-label="Heading self-link"></a></h3><p>AWS prodives the following <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html#manage-oidc-provider-console>Identity Provider Setup Instructions</a> on how to access and setup Identity Providers in AWS Console. However, Github&rsquo;s <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html#manage-oidc-provider-console>Adding the Identity Provider to AWS</a> guide provides specific details for configuring OIDC federated access from Github&rsquo;s CICD Action Workflows to AWS.</p><p>Add a new <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html#manage-oidc-provider-console>Identity Provider</a> using the web console. Go to IAM > Identity Provider.</p><ul><li>Select OpenID Connect.</li><li>Input <a href=https://token.actions.githubusercontent.com>https://token.actions.githubusercontent.com</a> in the <strong>Provider URL</strong></li><li>Input sts.amazonaws.com in the <strong>Audience</strong> field</li></ul><h3 id=configure-iam-role-and-trust-policies>Configure IAM Role and Trust Policies<a class=td-heading-self-link href=#configure-iam-role-and-trust-policies aria-label="Heading self-link"></a></h3><p>Create new IAM roles to allow for Federated OIDC authentication with AWS. For additional details, see Github&rsquo;s <a href=github-cicd-service-principal-read>Configuring the Role and Trust Policy</a>.</p><p>Add a new <a href=https://docs.aws.amazon.com/directoryservice/latest/admin-guide/create_role.html>IAM Role</a> using the web console. Go to IAM > Roles.
For the <em>github-cicd-service-principal-<strong>read</strong></em> account, name the associate role <strong>github-cicd-service-principal-read-sts-role</strong>.</p><ul><li>Attach the <strong>IAMReadOnlyAccess</strong> permission to the new role.</li><li>Add the following <a href=https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/>Trust Policy</a> to the new role.</li></ul><pre tabindex=0><code>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;Federated&#34;: &#34;[COPY AWS IAM IDENTITY PROVIDER ARN]&#34;
            },
            &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
            &#34;Condition&#34;: {
                &#34;StringLike&#34;: {
                    &#34;token.actions.githubusercontent.com:sub&#34;: &#34;repo:[GITHUB ORG NAME]/*:ref:refs/heads/main&#34;
                },
                &#34;ForAllValues:StringEquals&#34;: {
                    &#34;token.actions.githubusercontent.com:aud&#34;: &#34;sts.amazonaws.com&#34;,
                    &#34;token.actions.githubusercontent.com:iss&#34;: &#34;https://token.actions.githubusercontent.com&#34;
                }
            }
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;AWS&#34;: &#34;[COPY AWS IAM ACCOUNT FOR github-cicd-service-principal-read ARN]&#34;
            },
            &#34;Action&#34;: [
                &#34;sts:AssumeRole&#34;,
                &#34;sts:TagSession&#34;
            ],
            &#34;Condition&#34;: {}
        }
    ]
}
</code></pre><p>For the <em>github-cicd-service-principal-<strong>readwrite</strong></em> account, name the associate role <strong>github-cicd-service-principal-readwrite-sts-role</strong>.</p><ul><li>Attach the <strong>IAMFullAccess</strong> permission to the new role.</li><li>Add the following <a href=https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/>Trust Policy</a> to the new role.</li></ul><pre tabindex=0><code>
{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;Federated&#34;: &#34;[COPY AWS IAM IDENTITY PROVIDER ARN]&#34;
            },
            &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
            &#34;Condition&#34;: {
                &#34;StringLike&#34;: {
                    &#34;token.actions.githubusercontent.com:sub&#34;: &#34;repo:[GITHUB ORG NAME]/*:environment:production&#34;
                },
                &#34;ForAllValues:StringEquals&#34;: {
                    &#34;token.actions.githubusercontent.com:aud&#34;: &#34;sts.amazonaws.com&#34;,
                    &#34;token.actions.githubusercontent.com:iss&#34;: &#34;https://token.actions.githubusercontent.com&#34;
                }
            }
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;AWS&#34;: &#34;[COPY AWS IAM ACCOUNT FOR github-cicd-service-principal-readwrite ARN]&#34;
            },
            &#34;Action&#34;: [
                &#34;sts:AssumeRole&#34;,
                &#34;sts:TagSession&#34;
            ],
            &#34;Condition&#34;: {}
        }
    ]
}
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-e9ea5872e7a179cee48af8b342b1525a>1.4 - Microsoft Azure</h1><div class=lead>Azure - A comprehensive cloud computing platform provided by Microsoft.</div><p>Microsoft Azure is a comprehensive cloud computing platform that offers a wide array of services, including computing, storage, databases, analytics, artificial intelligence, Internet of Things (IoT), and more. Azure enables data practitioners and developers to build, deploy, and manage applications and workloads in a flexible, scalable, and secure global network. When setting up Azure for the first time, establishing robust security measures is paramount for data practitioners to ensure the confidentiality, integrity, and availability of their data and applications. Without proper security configurations, sensitive information can be exposed to unauthorized access, and accounts can become vulnerable to malicious activities if credentials are compromised. It&rsquo;s crucial to implement security best practices, such as Azure Active Directory (Azure AD) for identity and access management, Role-Based Access Control (RBAC), network security groups (NSGs), and Azure Security Center recommendations. By prioritizing security from the outset, data practitioners can mitigate common risks like overly permissive access, unsecured storage accounts, and compromised credentials.</p><h1 id=getting-started>Getting Started<a class=td-heading-self-link href=#getting-started aria-label="Heading self-link"></a></h1><p>The <strong>Azure CLI</strong> is a powerful command-line tool that allows users to interact with Azure services, enabling them to manage and automate various tasks such as creating and managing resources, deploying applications, and configuring services. Please visit the <a href=https://docs.microsoft.com/cli/azure/install-azure-cli>Official Azure CLI Installation Instructions</a> to review the installation steps for your operating system.</p><p>For a comprehensive development experience, consider these additional tools:</p><ul><li><strong>Azure PowerShell</strong>: Provides a set of cmdlets to manage Azure resources directly from PowerShell. <a href=https://docs.microsoft.com/powershell/azure/new-azureps-module-az>Learn more about Azure PowerShell</a>.</li><li><strong>Azure SDKs</strong>: Available for various programming languages (e.g., Python, .NET, Java, Node.js) to interact with Azure services programmatically. <a href=https://azure.microsoft.com/downloads/>Explore Azure SDKs</a>.</li><li><strong>Azure Tools for Visual Studio Code</strong>: An extension that makes it easy to develop and deploy to Azure directly from VS Code. <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.vscode-node-azure-pack">Install Azure Tools for VS Code</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-49076824f59c97f04453eaf3b3f6dbae>1.4.1 - Account Setup</h1><div class=lead>Azure - New Account Setup with Critical Security Measures Applied as First Priority.</div><h2 id=setup-new-azure-account>Setup New Azure Account<a class=td-heading-self-link href=#setup-new-azure-account aria-label="Heading self-link"></a></h2><p>Creating an Azure account can often start with a <a href=https://azure.microsoft.com/free/>free tier offering</a>. Similar to other cloud providers, establishing robust security measures from the beginning is crucial to protect your Azure resources, data, and identities from unauthorized access and potential threats. We will follow Azure&rsquo;s recommended practices for a secure initial setup.</p><h3 id=azure-resource-groups>Azure Resource Groups<a class=td-heading-self-link href=#azure-resource-groups aria-label="Heading self-link"></a></h3><p>Azure resource groups are a fundamental concept in Azure to organize resource into specific use case groups for cost and monitoring purposes. Before being able to create an resources in Azure, a <a href=https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-portal>Resource Group</a> must be created.</p><h3 id=microsoft-entra-id-azure-ad-foundation>Microsoft Entra ID (Azure AD) Foundation<a class=td-heading-self-link href=#microsoft-entra-id-azure-ad-foundation aria-label="Heading self-link"></a></h3><p><a href=https://learn.microsoft.com/en-ca/entra/fundamentals/whatis>Microsoft Entra</a> is Microsoft&rsquo;s cloud-based identity and access management service, more recently know as Microsoft Entra. It&rsquo;s the backbone for managing users, groups, and access to Azure resources. When you sign up for Azure, an Azure AD tenant is typically created for you.</p><h4 id=mfa-authentication>MFA Authentication<a class=td-heading-self-link href=#mfa-authentication aria-label="Heading self-link"></a></h4><p>MFA is a critical security layer to enforce ideally for all users. You can enable MFA through</p><ul><li><a href=https://docs.microsoft.com/azure/active-directory/fundamentals/concept-fundamentals-security-defaults>Security Defaults</a> (a baseline for all users)</li><li>Configure more granular policies using <a href=https://learn.microsoft.com/en-us/entra/identity/authentication/tutorial-enable-azure-mfa#configure-the-conditions-for-multifactor-authentication>Azure AD Conditional Access</a></li></ul><h4 id=new-user>New User<a class=td-heading-self-link href=#new-user aria-label="Heading self-link"></a></h4><p>Before creating resources, avoid using the administrative user account created by default when registering a new <a href=https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/design-area/resource-org-subscriptions>Azure Subscription</a>. Create a new user to provide Role-Based Access Control (RBAC) and MFA authentication. Use the <a href=https://learn.microsoft.com/en-us/entra/fundamentals/how-to-create-delete-users#invite-an-external-user>External Invite</a> mechanism to invite a new user into the Azure AD Tenant.</p><h4 id=new-ad-group--role-based-access-control-rbac>New AD Group & Role Based Access Control (RBAC)<a class=td-heading-self-link href=#new-ad-group--role-based-access-control-rbac aria-label="Heading self-link"></a></h4><p>Create <a href=https://learn.microsoft.com/en-us/entra/fundamentals/how-to-manage-groups>Microsoft Entra ID Groups</a> to apply permissions and access controls across multiple users. Add the newly create user following the <a href=https://learn.microsoft.com/en-us/entra/fundamentals/how-to-manage-groups#add-members-or-owners-of-a-group>Add Members</a> guide. Grant permissions to the newly created group using Azure RBAC <a href=https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#role-assignments>Role Assignment</a>. Assign the <code>Reader</code> role.</p><h4 id=conditional-access-policies>Conditional Access Policies<a class=td-heading-self-link href=#conditional-access-policies aria-label="Heading self-link"></a></h4><p>We can harden security when accessing Azure subscription/ tenant by utilizing <a href=https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-conditional-access-policies>Conditional Access Policies</a> by restricting access to specific IPs. Before defining the policy, create a <a href=https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-assignment-network#how-are-these-locations-defined>Named Location</a> to name and refer to the trusted IP range.</p><h3 id=cli-access-for-usersdevelopers>CLI Access for Users/Developers<a class=td-heading-self-link href=#cli-access-for-usersdevelopers aria-label="Heading self-link"></a></h3><p>To authenticate the Azure CLI and allow users to manage Azure resources from their command line, the primary method is interactive login. This process leverages Microsoft Entra ID for authentication, including any configured MFA or Conditional Access policies.</p><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Login to Azure (this will open a browser for authentication)</span>
</span></span><span style=display:flex><span>  az login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Set the default Subscription and Resource Group</span>
</span></span><span style=display:flex><span>  az account <span style=color:#204a87>set</span> --subscription <span style=color:#ce5c00;font-weight:700>[</span>INSERT SUBSCRIPTION ID<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>  az configure --defaults <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>=[</span>INSERT RESOURCE GROUP NAME<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># [Prefered] If you have a User-Assigned Managed Identity</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Sign-in to Azure with the User-Assigned Managed Identity</span>
</span></span><span style=display:flex><span>  az login --identity --client-id <span style=color:#ce5c00;font-weight:700>[</span>INSERT CLIENT ID<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=service-principal-programmatic-access>Service Principal (Programmatic Access)<a class=td-heading-self-link href=#service-principal-programmatic-access aria-label="Heading self-link"></a></h2><p>To enable programmatic access to Azure resources, you can create a Service Principal using either:</p><ul><li>Enterprise Application (Service Principal) used by applications, services, or automation tools to access specific Azure resources programmatically.</li><li>User-Assigned Managed Identity, an identity created as a standalone Azure resource, which can be assigned to one or more Azure resources. It is managed by Azure and does not require you to handle credentials. Recommended for scenarios where you want to share an identity across multiple resources.</li><li>System-Assigned Managed Identity, an identity enabled directly on an Azure resource (such as a VM, App Service, or Function). The lifecycle of this identity is tied to the resource, and credentials are managed automatically by Azure. Use this when the identity is only needed for a single resource.</li></ul><p>For most automation and service-to-service scenarios, Azure recommends using Managed Identities and short-term credentials. These credentials are generated dynamically and do not require you to manage or rotate long-term secrets.</p><h3 id=enterprise-application>Enterprise Application<a class=td-heading-self-link href=#enterprise-application aria-label="Heading self-link"></a></h3><h4 id=programmatic-steps>Programmatic Steps<a class=td-heading-self-link href=#programmatic-steps aria-label="Heading self-link"></a></h4><ul class="nav nav-tabs justify-content-end" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=shell aria-controls=tabs-01-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li><li class=nav-item><button class=nav-link id=tabs-01-03-tab data-bs-toggle=tab data-bs-target=#tabs-01-03 role=tab data-td-tp-persist=hcl aria-controls=tabs-01-03 aria-selected=false>
<span style=vertical-align:middle><img src=https://cdn.simpleicons.org/terraform/5835CC alt="Terraform icon" style=height:1em;vertical-align:middle;margin-right:.3em></span>
Terraform</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_RESOURCE_GROUP</span><span style=color:#ce5c00;font-weight:700>=</span>example-rg
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_LOCATION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;eastus&#34;</span> <span style=color:#8f5902;font-style:italic># Choose your desired Azure region</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a new Azure Resource Group</span>
</span></span><span style=display:flex><span>az group create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name example-rg <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location <span style=color:#000>$AZURE_LOCATION</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a new Microsoft Entra AD Group</span>
</span></span><span style=display:flex><span>az ad group create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --display-name example-group <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --mail-nickname ex-group
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a new Service Principal (Application Registration)</span>
</span></span><span style=display:flex><span>az ad sp create-for-rbac <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name example-sp <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --skip-assignment
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Assign the &#34;Reader&#34; role to the AD Group for the Resource Group</span>
</span></span><span style=display:flex><span>az role assignment create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assignee <span style=color:#4e9a06>&#34;example-group&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role Reader <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resource-group example-rg
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove the Reader role assignment from the AD Group</span>
</span></span><span style=display:flex><span>az role assignment delete <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assignee <span style=color:#4e9a06>&#34;example-group&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role Reader <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resource-group example-rg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete the Service Principal</span>
</span></span><span style=display:flex><span>az ad sp delete --id example-sp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete the AD Group</span>
</span></span><span style=display:flex><span>az ad group delete --group <span style=color:#4e9a06>&#34;example-group&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete the Resource Group (removes all resources within it!)</span>
</span></span><span style=display:flex><span>az group delete --name example-rg
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-03 role=tabpanel aria-labelled-by=tabs-01-03-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HCL data-lang=HCL><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## AZUREAD PROVIDER
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Azure Active Directory (AzureAD) provider authenticated with CLI.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>provider</span> <span style=color:#4e9a06>&#34;azuread&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tokengen&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## AZURRM PROVIDER
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Azure Resource Manager (Azurerm) provider authenticated with CLI.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>provider</span> <span style=color:#4e9a06>&#34;azurerm&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tokengen&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>features</span> {}
</span></span><span style=display:flex><span>}<span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## AZURE SERVICE ACCOUNT MODULE
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## This module provisions an Azure service account along with associated roles and security groups.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Parameters:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `application_display_name`: The display name of the Azure application.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `role_name`: The name of the role for the Azure service account.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `security_group_name`: The name of the security group.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Providers:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `azuread.tokengen`: Alias for the Azure AD provider for generating tokens.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `azurerm.tokengen`: Alias for the Azure Resource Manager (Azurerm) provider for generating tokens.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>module</span> <span style=color:#4e9a06>&#34;azure_service_account&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  source</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;github.com/sim-parables/terraform-azure-service-account&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  application_display_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;example-service-account&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>  role_name</span>                <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;example-service-account-role&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>  security_group_name</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;example-group&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  providers</span> <span style=color:#ce5c00;font-weight:700>=</span> {
</span></span><span style=display:flex><span><span style=color:#000>    azuread.tokengen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>azuread</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>tokengen</span>
</span></span><span style=display:flex><span><span style=color:#000>    azurerm.tokengen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>azurerm</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>tokengen</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h4 id=console>Console<a class=td-heading-self-link href=#console aria-label="Heading self-link"></a></h4><p>For applications, services, or automation tools that need to access or modify Azure resources without direct user interaction, use Service Principals. Create a new <a href=https://learn.microsoft.com/en-us/entra/identity-platform/howto-create-service-principal-portal#register-an-application-with-microsoft-entra-id-and-create-a-service-principal>Service Principal</a> can be used for applications, services or automation tools which need to access or modify Azure resources without direct user interaction. However, SPs require credebtials and token management for authentication which can pose a security risk if handled incorrectly.</p><h3 id=user-assigned-managed-identities>User-Assigned Managed Identities<a class=td-heading-self-link href=#user-assigned-managed-identities aria-label="Heading self-link"></a></h3><h4 id=programmatic-steps-1>Programmatic Steps<a class=td-heading-self-link href=#programmatic-steps-1 aria-label="Heading self-link"></a></h4><ul class="nav nav-tabs justify-content-end" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=shell aria-controls=tabs-02-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a User-Assigned Managed Identity</span>
</span></span><span style=display:flex><span>az identity create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name example-sp-managed-identity <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resource-group example-rg <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location useast
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (Optional) Assign a role to the Managed Identity for a resource group</span>
</span></span><span style=display:flex><span>az role assignment create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assignee <span style=color:#4e9a06>&#34;example-group&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role Reader <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resource-group example-rg
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove the Reader role assignment from the Managed Identity (if assigned)</span>
</span></span><span style=display:flex><span>az role assignment delete <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assignee <span style=color:#4e9a06>&#34;example-group&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role Reader <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resource-group example-rg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete the User-Assigned Managed Identity</span>
</span></span><span style=display:flex><span>az identity delete <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name example-sp-managed-identity <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resource-group example-rg
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h4 id=console-1>Console<a class=td-heading-self-link href=#console-1 aria-label="Heading self-link"></a></h4><p>Managed Identities are <a href=https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview>Workload Identities</a> which manage Service Principal and authentication without needing to managed secrets and credentials independently. Create a <a href="https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp#create-a-user-assigned-managed-identity">User-Assigned Managed Identity</a> in place of a Service Principal for the same use cases, and apply necessary roles for least-priviledge access. Finalize the configuration of the User-Assigned Managed Identity by <a href="https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp#create-a-user-assigned-managed-identity">Managing Access</a> to restrict use to specific users or groups.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2272d5c519c02840f7ed49134a7bb4c7>1.4.2 - Terraform Backend</h1><div class=lead>Azure - Optional Configurations When Not Using Terraform.io Workspace Backends.</div><h1 id=terraform-backend-with-azure>Terraform Backend with Azure<a class=td-heading-self-link href=#terraform-backend-with-azure aria-label="Heading self-link"></a></h1><p>Using Azure as the backend for Terraform state is a robust and versatile option for managing infrastructure as code. By storing Terraform state in an Azure Blob Storage container, teams can leverage Azure&rsquo;s comprehensive security features, including encryption at rest and in transit, access controls via Azure Active Directory (Azure AD) and Role-Based Access Control (RBAC), and versioning capabilities. Azure Blob Storage offers a highly durable and available storage solution, ensuring that Terraform state is consistently accessible and protected. Furthermore, using Azure for the backend allows teams to utilize Azure AD for fine-grained control over who can read and write to the state file and manage state locking. This setup also integrates well with other Azure services like Azure Functions and Azure Monitor, enabling automation and monitoring of Terraform workflows for a seamless infrastructure management experience.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p ~/development/test/example_azure_tf_backend
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_azure_tf_backend
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Setting</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_LOCATION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;eastus&#34;</span> <span style=color:#8f5902;font-style:italic># Choose your desired Azure region</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_CLIENT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az identity list <span style=color:#000;font-weight:700>|</span> head -n 1<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>RAND_SUFFIX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 4<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_RESOURCE_GROUP_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;rg-tfstate-</span><span style=color:#4e9a06>${</span><span style=color:#000>RAND_SUFFIX</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Azure Storage Account names must be 3-24 characters, lowercase letters and numbers, and globally unique.</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_STORAGE_ACCOUNT_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;tfstate-</span><span style=color:#4e9a06>${</span><span style=color:#000>RAND_SUFFIX</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> tr <span style=color:#4e9a06>&#39;[:upper:]&#39;</span> <span style=color:#4e9a06>&#39;[:lower:]&#39;</span> <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/[^a-z0-9]//g&#39;</span> <span style=color:#000;font-weight:700>|</span> cut -c1-24<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_STORAGE_CONTAINER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;tfstate&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>TF_STATE_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;sandbox/terraform.tfstate&#34;</span> <span style=color:#8f5902;font-style:italic># Path for the Terraform state file in the container</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Login to Azure</span>
</span></span><span style=display:flex><span>az login --identity --client-id <span style=color:#000>$AZURE_CLIENT_ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Get Subscription and Tenant IDs for Terraform configuration</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_SUBSCRIPTION_ID_FOR_TF</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az account show --query id -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_TENANT_ID_FOR_TF</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az account show --query tenantId -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a Resource Group for the Terraform backend</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://docs.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az_group_create</span>
</span></span><span style=display:flex><span>az group create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_RESOURCE_GROUP_NAME</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_LOCATION</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>az configure --defaults <span style=color:#000>group</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$AZURE_RESOURCE_GROUP_NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a Storage Account for Terraform State</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://docs.microsoft.com/en-us/cli/azure/storage/account?view=azure-cli-latest#az_storage_account_create</span>
</span></span><span style=display:flex><span>az storage account create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_STORAGE_ACCOUNT_NAME</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resource-group <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_RESOURCE_GROUP_NAME</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_LOCATION</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --sku Standard_LRS <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --kind StorageV2 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --encryption-services blob <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --allow-blob-public-access <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a Blob Container for Terraform State</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://docs.microsoft.com/en-us/cli/azure/storage/container?view=azure-cli-latest#az_storage_container_create</span>
</span></span><span style=display:flex><span>az storage container create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_STORAGE_CONTAINER_NAME</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --account-name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_STORAGE_ACCOUNT_NAME</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Get the Object ID (Principal ID) of the managed identity&#39;s service principal using its Client ID.</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>MANAGED_IDENTITY_OBJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az ad sp show --id <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_CLIENT_ID</span><span style=color:#4e9a06>&#34;</span> --query <span style=color:#4e9a06>&#34;id&#34;</span> -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># AZURE_SUBSCRIPTION_ID_FOR_TF is already set and can be used for the scope.</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>CONTAINER_SCOPE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/subscriptions/</span><span style=color:#000>$AZURE_SUBSCRIPTION_ID_FOR_TF</span><span style=color:#4e9a06>/resourceGroups/</span><span style=color:#000>$AZURE_RESOURCE_GROUP_NAME</span><span style=color:#4e9a06>/providers/Microsoft.Storage/storageAccounts/</span><span style=color:#000>$AZURE_STORAGE_ACCOUNT_NAME</span><span style=color:#4e9a06>/blobServices/default/containers/</span><span style=color:#000>$AZURE_STORAGE_CONTAINER_NAME</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>az role assignment create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --role <span style=color:#4e9a06>&#34;Storage Blob Data Contributor&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --assignee-object-id <span style=color:#4e9a06>&#34;</span><span style=color:#000>$MANAGED_IDENTITY_OBJECT_ID</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --assignee-principal-type ServicePrincipal <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --scope <span style=color:#4e9a06>&#34;</span><span style=color:#000>$CONTAINER_SCOPE</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Role assignment may take a moment to propagate. Wait for 30 seconds before continuing.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure Terraform</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; backend.conf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>resource_group_name  = &#34;$AZURE_RESOURCE_GROUP_NAME&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>storage_account_name = &#34;$AZURE_STORAGE_ACCOUNT_NAME&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>container_name       = &#34;$AZURE_STORAGE_CONTAINER_NAME&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>key                  = &#34;$TF_STATE_KEY&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>use_azuread_auth     = true # Authenticate using Azure Active Directory.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># Explicitly use the managed identity (whose client ID is in $AZURE_CLIENT_ID)
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># for backend authentication. The `az login --identity` command sets the CLI context,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># and these details ensure Terraform uses that specific identity for the backend.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>client_id            = &#34;$AZURE_CLIENT_ID&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>subscription_id      = &#34;$AZURE_SUBSCRIPTION_ID_FOR_TF&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>tenant_id            = &#34;$AZURE_TENANT_ID_FOR_TF&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; terraform.tfvars
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>azure_subscription_id            = &#34;$AZURE_SUBSCRIPTION_ID_FOR_TF&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>azure_tenant_id                  = &#34;$AZURE_TENANT_ID_FOR_TF&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>user_assigned_identity_client_id = &#34;$AZURE_CLIENT_ID&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># azure_location                 = &#34;$AZURE_LOCATION&#34; # Example if you have a location variable
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># You can define variables for your Azure resources here if needed.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># For example, if your main.tf creates resources in a specific location:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># location = &#34;East US&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; variables.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;user_assigned_identity_client_id&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;Client ID of the User-Assigned Managed Identity to use for authentication by the provider.&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;azure_subscription_id&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;Azure Subscription ID to be used by the Azure provider.&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;azure_tenant_id&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;Azure Tenant ID to be used by the Azure provider.&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># variable &#34;azure_location&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>#   type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>#   description = &#34;The Azure region where resources will be deployed.&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>#   default     = &#34;East US&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; main.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>/* Azure Blob Storage managed terraform state - configurations in backend.conf */
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>terraform {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  backend &#34;azurerm&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    // Backend configuration is provided via the backend.conf file
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    // during `terraform init -backend-config=backend.conf`
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>provider &#34;azurerm&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  features {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  # Explicitly configure the provider to use the User-Assigned Managed Identity.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  # The values are supplied through terraform.tfvars (sourced from script variables).
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  # This ensures Terraform uses the specified managed identity for managing Azure resources.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  use_msi         = true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  client_id       = var.user_assigned_identity_client_id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  subscription_id = var.azure_subscription_id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  tenant_id       = var.azure_tenant_id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># Example: Add a data source to verify provider configuration
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data &#34;azurerm_subscription&#34; &#34;current&#34; {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>output &#34;current_azure_subscription_display_name&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  value = data.azurerm_subscription.current.display_name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Test Terraform</span>
</span></span><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span>terraform apply --auto-approve
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure environment variables are set from the Create step</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Tear Down Terraform</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_azure_tf_backend <span style=color:#8f5902;font-style:italic># Ensure you are in the correct directory</span>
</span></span><span style=display:flex><span>terraform destroy --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove the Azure Resource Group containing the Storage Account and Container</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This will delete all resources created by this script for the backend.</span>
</span></span><span style=display:flex><span>az group delete <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_RESOURCE_GROUP_NAME</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --yes <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --no-wait <span style=color:#8f5902;font-style:italic># Use --no-wait to run in background, or remove for synchronous deletion</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><p>This section outlines how to set up the Azure backend for Terraform using the Azure portal. You will need to manually create the necessary Azure resources and then configure your Terraform files.</p><h3 id=create-azure-resources>Create Azure Resources<a class=td-heading-self-link href=#create-azure-resources aria-label="Heading self-link"></a></h3><p>You&rsquo;ll need to create the following resources in the Azure portal. Make sure to note down their names and other relevant properties (like location) as you create them.</p><ul><li><strong>Resource Group:</strong> A container that holds related resources for an Azure solution.<ul><li><a href=https://learn.microsoft.com/azure/azure-resource-manager/management/manage-resource-groups-portal>Learn how to create a Resource Group in the Azure portal</a></li></ul></li><li><strong>Storage Account:</strong> To store your Terraform state file.<ul><li>When creating a <a href="https://learn.microsoft.com/en-us/azure/storage/common/storage-account-create?tabs=azure-portal">Storage Account</a>, ensure you configure it appropriately for a Terraform backend (e.g., Account kind: <code>StorageV2</code>, Performance: <code>Standard</code>, Replication: <code>Locally-redundant storage (LRS)</code>). It&rsquo;s also recommended to disable public blob access for security. Add a Storage Container for the state file.</li></ul></li></ul><h3 id=configure-managed-identity-and-permissions>Configure Managed Identity and Permissions<a class=td-heading-self-link href=#configure-managed-identity-and-permissions aria-label="Heading self-link"></a></h3><p>Terraform will authenticate to Azure using a User-Assigned Managed Identity.</p><ul><li><strong>Assign &lsquo;Storage Blob Data Contributor&rsquo; Role:</strong> <a href="(https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp#create-a-user-assigned-managed-identity)">Grant the Managed Identity</a> the necessary permissions to read and write to the blob container by assigning the <code>Storage Blob Data Contributor</code> role to your User-Assigned Managed Identity.</li></ul><h3 id=configure-terraform-files>Configure Terraform Files<a class=td-heading-self-link href=#configure-terraform-files aria-label="Heading self-link"></a></h3><p>After setting up the Azure resources and permissions, you need to create the following <a href=https://developer.hashicorp.com/terraform/language/backend/azurerm>Terraform Backend Configuration</a> <code>backend.conf</code> with the actual values you obtained from the Azure portal.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#000>resource_group_name</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;YOUR_RESOURCE_GROUP_NAME&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>storage_account_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;YOUR_STORAGE_ACCOUNT_NAME&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>container_name</span>       <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;YOUR_CONTAINER_NAME&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>key</span>                  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;sandbox/terraform.tfstate&#34;</span><span style=color:#8f5902;font-style:italic> # Or your desired state file path in the container
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>use_azuread_auth</span>     <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
</span></span><span style=display:flex><span><span style=color:#000>client_id</span>            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;YOUR_MANAGED_IDENTITY_CLIENT_ID&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>subscription_id</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;YOUR_AZURE_SUBSCRIPTION_ID&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>tenant_id</span>            <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;YOUR_AZURE_TENANT_ID&#34;</span>
</span></span></code></pre></div><p>Once the Azure resources are ready and your Terraform files are configured with the correct values, navigate to your Terraform project directory in your terminal and run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span>terraform apply --auto-approve
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1c163698e334dd4401ddcdc57074abd9>1.4.3 - OpenID Connect</h1><div class=lead>Azure - Modernized Security for GitOps & CI/CD with GitHub Actions using Microsoft Identity Platform.</div><h1 id=openid-connect-oidc-with-github-actions-and-azure-workload-identity-federation>OpenID Connect (OIDC) with GitHub Actions and Azure Workload Identity Federation<a class=td-heading-self-link href=#openid-connect-oidc-with-github-actions-and-azure-workload-identity-federation aria-label="Heading self-link"></a></h1><p>Azure&rsquo;s <a href=https://learn.microsoft.com/en-us/azure/active-directory/workload-identities/workload-identity-federation>Workload identity federation</a> allows external OpenID Connect (OIDC) providers, like GitHub Actions, to authenticate to Azure Active Directory (Azure AD) and obtain access tokens for Azure resources. This is achieved by configuring a federated identity credential on an Azure AD application registration or user-assigned managed identity. This enables your GitHub Actions workflows to securely access Azure resources without needing to manage or store long-lived secrets (like client secrets or certificates) in GitHub. Instead, workflows exchange their OIDC token for a short-lived Azure AD access token, enhancing security and simplifying credential management for CI/CD pipelines.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p ~/development/test/example_azure_oidc
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_azure_oidc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 0. Prerequisites &amp; Configuration</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure Azure CLI (az) is installed and you are logged in.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Run `az login` and `az account set --subscription &#34;YOUR_SUBSCRIPTION_ID&#34;` if needed.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure GitHub CLI (gh) is installed and authenticated if using it to get repo details.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Azure Configuration</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_SUBSCRIPTION_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az account show --query id -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_RESOURCE_GROUP_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az configure --list-defaults --query <span style=color:#4e9a06>&#34;[?name==&#39;group&#39;].value&#34;</span> -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_TENANT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az account show --query tenantId -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># GitHub Configuration</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_OWNER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;your-github-username-or-org&#34;</span> <span style=color:#8f5902;font-style:italic># Replace with your GitHub username or organization</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_REPO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;your-github-repo-name&#34;</span>    <span style=color:#8f5902;font-style:italic># Replace with your GitHub repository name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Azure AD Application and Federated Credential Configuration</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_APP_REG_DISPLAY_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;github-</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>-</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>-oidc-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 2<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_FEDERATED_CREDENTIAL_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;github-federated-credential-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 2<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Subject claim for the federated credential (identifies the GitHub Actions workflow)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This example targets the main branch. Adjust as needed (e.g., for specific tags, pull requests, or environments).</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Common subject formats:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># - Specific branch: repo:${GH_OWNER}/${GH_REPO}:ref:refs/heads/main</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># - Any branch: repo:${GH_OWNER}/${GH_REPO}:ref:refs/heads/*</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># - Any tag: repo:${GH_OWNER}/${GH_REPO}:ref:refs/tags/*</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># - Pull requests: repo:${GH_OWNER}/${GH_REPO}:pull_request</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># - Specific environment: repo:${GH_OWNER}/${GH_REPO}:environment:production</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_SUBJECT_CLAIM</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;repo:</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:ref:refs/heads/main&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 1. Create an Azure AD Application Registration</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This application will represent your GitHub Actions workflow in Azure AD.</span>
</span></span><span style=display:flex><span><span style=color:#000>APP_REG_JSON</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az ad app create --display-name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_APP_REG_DISPLAY_NAME</span><span style=color:#4e9a06>&#34;</span> --sign-in-audience AzureADMyOrg<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_APP_OBJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$APP_REG_JSON</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.id&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_APP_CLIENT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$APP_REG_JSON</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.appId&#39;</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Also known as Application (client) ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 2. Create a Service Principal for the Application Registration (if not already created)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># A service principal is an instance of an application in a directory.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># It&#39;s usually created automatically when the app registration is created.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># We need its Object ID for role assignments.</span>
</span></span><span style=display:flex><span><span style=color:#000>SP_JSON</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az ad sp create --id <span style=color:#000>$AZURE_APP_CLIENT_ID</span><span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># This command creates if not exists, or returns existing</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_SERVICE_PRINCIPAL_OBJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$SP_JSON</span> <span style=color:#000;font-weight:700>|</span> jq -r <span style=color:#4e9a06>&#39;.id&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 3. Add a Federated Identity Credential to the Application Registration</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This configures the trust relationship between Azure AD and GitHub OIDC.</span>
</span></span><span style=display:flex><span>az ad app federated-credential create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --id <span style=color:#000>$AZURE_APP_OBJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --parameters <span style=color:#4e9a06>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &#34;name&#34;: &#34;${AZURE_FEDERATED_CREDENTIAL_NAME}&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &#34;issuer&#34;: &#34;https://token.actions.githubusercontent.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &#34;subject&#34;: &#34;${GH_SUBJECT_CLAIM}&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &#34;description&#34;: &#34;Federated credential for GitHub Actions OIDC&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    &#34;audiences&#34;: [&#34;api://AzureADTokenExchange&#34;]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  }&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 4. Grant necessary permissions (Azure RBAC roles) to the Service Principal</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Adjust the role and scope based on what your GitHub Actions workflow needs to do.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example: Grant &#34;Storage Blob Data Contributor&#34; on a specific resource group.</span>
</span></span><span style=display:flex><span>az role assignment create <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assignee <span style=color:#000>$AZURE_SERVICE_PRINCIPAL_OBJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role <span style=color:#4e9a06>&#34;Storage Blob Data Contributor&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --scope <span style=color:#4e9a06>&#34;/subscriptions/</span><span style=color:#000>$AZURE_SUBSCRIPTION_ID</span><span style=color:#4e9a06>/resourceGroups/</span><span style=color:#000>$AZURE_RESOURCE_GROUP_NAME</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># To grant on the entire subscription: --scope &#34;/subscriptions/$AZURE_SUBSCRIPTION_ID&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure environment variables from the Create step are set, or re-define them:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Retrieve IDs if not set (assuming display name is unique enough for this script)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_APP_OBJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az ad app list --display-name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_APP_REG_DISPLAY_NAME</span><span style=color:#4e9a06>&#34;</span> --query <span style=color:#4e9a06>&#34;[0].id&#34;</span> -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_APP_CLIENT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az ad app show --id <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_APP_OBJECT_ID</span><span style=color:#4e9a06>&#34;</span> --query <span style=color:#4e9a06>&#34;appId&#34;</span> -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>AZURE_SERVICE_PRINCIPAL_OBJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az ad sp list --display-name <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AZURE_APP_REG_DISPLAY_NAME</span><span style=color:#4e9a06>&#34;</span> --query <span style=color:#4e9a06>&#34;[?appId==&#39;</span><span style=color:#000>$AZURE_APP_CLIENT_ID</span><span style=color:#4e9a06>&#39;].id&#34;</span> -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. Remove Azure RBAC role assignments granted to the Service Principal</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># You need to know the role and scope that was assigned.</span>
</span></span><span style=display:flex><span>az role assignment delete <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --assignee <span style=color:#000>$AZURE_SERVICE_PRINCIPAL_OBJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role <span style=color:#4e9a06>&#34;Storage Blob Data Contributor&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --scope <span style=color:#4e9a06>&#34;/subscriptions/</span><span style=color:#000>$AZURE_SUBSCRIPTION_ID</span><span style=color:#4e9a06>/resourceGroups/</span><span style=color:#000>$AZURE_RESOURCE_GROUP_NAME</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Delete the Federated Identity Credential</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># To delete a specific federated credential, you&#39;d ideally use its ID.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Listing them to find the one to delete if name is known:</span>
</span></span><span style=display:flex><span><span style=color:#000>CREDENTIAL_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>az ad app federated-credential list --id <span style=color:#000>$AZURE_APP_OBJECT_ID</span> --query <span style=color:#4e9a06>&#34;[?name==&#39;</span><span style=color:#000>$AZURE_FEDERATED_CREDENTIAL_NAME</span><span style=color:#4e9a06>&#39;].id&#34;</span> -o tsv<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>az ad app federated-credential delete --id <span style=color:#000>$AZURE_APP_OBJECT_ID</span> --federated-credential-id <span style=color:#000>$CREDENTIAL_ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Delete the Azure AD Application Registration</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This will also delete the associated Service Principal.</span>
</span></span><span style=display:flex><span>az ad app delete --id <span style=color:#000>$AZURE_APP_OBJECT_ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><h3 id=1-create-azure-ad-application-registration>1. Create Azure AD Application Registration<a class=td-heading-self-link href=#1-create-azure-ad-application-registration aria-label="Heading self-link"></a></h3><p>Begin this OIDC process by first <a href=https://learn.microsoft.com/en-us/azure/healthcare-apis/register-application>Registering a Client Application</a> in Microsoft Entra ID. Provide a name like <code>github-actions-myrepo-oidc</code>, and note down the <strong>Application (client) ID</strong>.</p><h3 id=2-add-a-federated-identity-credential>2. Add a Federated Identity Credential<a class=td-heading-self-link href=#2-add-a-federated-identity-credential aria-label="Heading self-link"></a></h3><p>Once the App Registration is created, configure <a href=https://learn.microsoft.com/en-us/entra/workload-id/workload-identity-federation>Workload Identity Federation</a> to establish <a href="https://learn.microsoft.com/en-us/entra/workload-id/workload-identity-federation-create-trust?pivots=identity-wif-apps-methods-azp#github-actions">Trust with GitHub Actions OIDC</a>.</p><p><strong>Example Identities for GitHub Actions in Azure Portal (Subject Identifier in Federated Credential):</strong></p><ul><li>To allow workflows from a specific repository and specific branch (e.g., <code>main</code>):
<code>repo:GITHUB_OWNER/GITHUB_REPO_NAME:ref:refs/heads/main</code></li><li>To allow workflows from a specific repository and specific environment (e.g., <code>production</code>):
<code>repo:GITHUB_OWNER/GITHUB_REPO_NAME:environment:production</code></li></ul><p><em>Also, a managed identity can be configured to establish trust with Github Actions OIDC. More details <a href="https://learn.microsoft.com/en-us/entra/workload-id/workload-identity-federation-create-trust-user-assigned-managed-identity?pivots=identity-wif-mi-methods-azp">here</a></em></p><h3 id=3-grant-permissions-assign-azure-rbac-roles-to-the-service-principal>3. Grant Permissions (Assign Azure RBAC Roles) to the Service Principal<a class=td-heading-self-link href=#3-grant-permissions-assign-azure-rbac-roles-to-the-service-principal aria-label="Heading self-link"></a></h3><p>The App Registration has an associated Service Principal. You need to <a href=https://learn.microsoft.com/en-us/azure/role-based-access-control/role-assignments-steps>Grant this Service Principal</a> the necessary permissions (Azure RBAC roles) on the Azure resources your GitHub Actions workflow will manage.
Select the appropriate <strong>Role</strong> (e.g., <code>Contributor</code>, <code>Reader</code>, <code>Storage Blob Data Contributor</code>) that provides the least privilege necessary.</p><p><strong>Assign roles</strong>: Assign the necessary Azure RBAC roles to the Service Principal of your App Registration. For example:</p><ul><li><code>github-cicd-read-sp</code> might be impersonable by <code>repo:ORG/REPO:ref:refs/heads/*</code> (any branch) and have the <code>Reader</code> role on a resource group.</li><li><code>github-cicd-deploy-sp</code> might be impersonable by <code>repo:ORG/REPO:ref:refs/heads/main</code> or <code>repo:ORG/REPO:environment:production</code> and have the <code>Contributor</code> role on a resource group.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-678e43bc7d6fc02e9e59fd22f3421ddb>1.5 - Google Cloud Platform (GCP)</h1><div class=lead>GCP - A suite of cloud computing services provided by Google, offering a wide array of tools for data practitioners.</div><p>GCP (Google Cloud Platform) is a comprehensive suite of cloud computing services offered by Google. It provides a wide array of services, including computing, storage, databases, big data analytics, machine learning, and more. GCP enables data practitioners to build, deploy, and manage applications and workloads in a flexible, scalable, and secure environment. When setting up GCP for the first time, focusing on security is paramount for data practitioners to ensure the confidentiality and integrity of their data and applications. Without robust security measures, sensitive information can be vulnerable to unauthorized access, and for hobbyists, compromised credentials can lead to malicious activities and unexpected costs. It&rsquo;s crucial to implement security best practices, such as Identity and Access Management (IAM), strong authentication and authorization controls, and network security (VPC, Firewalls) to safeguard against potential threats. By prioritizing security from the start, data practitioners can avoid common pitfalls like misconfigured Cloud Storage buckets, overly permissive IAM roles, and compromised service account keys.</p><h1 id=getting-started>Getting Started<a class=td-heading-self-link href=#getting-started aria-label="Heading self-link"></a></h1><p>The <strong>gcloud CLI</strong> (Google Cloud CLI) is a powerful command-line tool that allows users to interact with Google Cloud services. It enables you to manage and automate various tasks, such as creating and managing resources, deploying applications, and configuring services. Please visit the <a href=https://cloud.google.com/sdk/docs/install>Official Google Cloud CLI Installation Instructions</a> to review the installation steps. For enhanced development workflows, consider using <a href=https://cloud.google.com/code>Cloud Code</a>, which provides IDE extensions for VS Code and JetBrains IDEs to help write, debug, and deploy applications to Google Cloud.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0d86a12c9c001657acfee1fd19a167bc>1.5.1 - Account Setup</h1><div class=lead>GCP - New Account Setup with Critical Security Measures Applied as First Priority.</div><h2 id=setup-new-account>Setup New Account<a class=td-heading-self-link href=#setup-new-account aria-label="Heading self-link"></a></h2><p>Creating a Google Cloud Platform (GCP) presence starts with a Google Account. If you don&rsquo;t have one, you can create one for free. You&rsquo;ll then create a &ldquo;Project&rdquo; within GCP to organize your resources. Billing is managed through a &ldquo;Billing Account&rdquo; linked to your projects. More details can be found at the <a href=https://cloud.google.com/docs/get-started>GCP Get Started page</a>.
It&rsquo;s critical to implement robust security measures from the outset to protect your GCP resources and data from unauthorized access and potential breaches. We will follow Google&rsquo;s recommended security best practices.</p><h3 id=gcp-organization-setup-recommended-for-businesses>GCP Organization Setup (Recommended for Businesses)<a class=td-heading-self-link href=#gcp-organization-setup-recommended-for-businesses aria-label="Heading self-link"></a></h3><p>If you are using Google Workspace or Cloud Identity, setting up a GCP Organization is highly recommended. An Organization is the root node of the Google Cloud resource hierarchy and provides centralized control over all your GCP resources, projects, and billing. It allows you to define organization-wide policies and manage IAM permissions effectively. However, setting up a GCP organization with free tier Workspaces or Cloud Identity requires at minium a paid domain with email access - <strong>which is out-of-scope for our requirements</strong>.</p><ul><li>Learn more about <a href=https://cloud.google.com/resource-manager/docs/creating-managing-organization>Creating and Managing Organizations</a>. This is a foundational step for robust governance.</li><li>Visit <a href="https://support.google.com/a/answer/6043576?hl=en&amp;ref_topic=4388346&amp;sjid=6365213940035972062-NC">Sign-Up for Google Workspace</a> to create a new Google Workspace, or <a href="https://support.google.com/cloudidentity/answer/7389973?hl=en">Sign-Up for Cloud Identity</a> for Cloud Identity to register users with limited access to Google Services.</li></ul><p>GCP uses Google Accounts for authentication. For managing users, especially in a team or enterprise setting, it&rsquo;s best to use Google Workspace or Cloud Identity. These services act as your identity provider.</p><ul><li><strong>Create Users/Groups</strong>: <a href=https://cloud.google.com/iam/docs/groups-in-cloud-console>Manage your users and create groups</a> (e.g., <code>project-admins</code>, <code>project-developers</code>) within your Google Workspace or Cloud Identity admin console. Managing users in Cloud Identity.</li><li><strong>Enforce Multi-Factor Authentication (MFA/2SV)</strong>: Crucially, enforce 2-Step Verification (Google&rsquo;s term for MFA) for all Google Accounts that will access GCP. This is configured at the Google Account level or enforced via Google Workspace/Cloud Identity policies. Deploy 2-Step Verification.</li><li><strong>Grant IAM Roles</strong>: In GCP, you <a href=https://cloud.google.com/iam/docs/grant-role-console>Grant IAM roles</a> to principals (users, groups, service accounts) on specific resources (Organization, Folders, Projects). Start by granting roles to your Google Groups. For example, grant the <code>roles/owner</code> or more specific administrative roles (e.g., <code>roles/resourcemanager.projectCreator</code>, <code>roles/billing.admin</code>) to your <code>project-admins</code> group at the Organization or Folder level. Follow the principle of least privilege. Understanding IAM Roles.</li><li><strong>Accessing the GCP Console</strong>: Users will log in to the <a href=https://cloud.google.com>Google Cloud Console</a> using their Google Account credentials.</li></ul><h3 id=gcp-projects>GCP Projects<a class=td-heading-self-link href=#gcp-projects aria-label="Heading self-link"></a></h3><p>A GCP Project is the base-level organizing entity for everything you do in Google Cloud. Think of it as a container for all your cloud resources. All GCP resources you create, such as Virtual Machines (Compute Engine instances), Cloud Storage buckets, BigQuery datasets, Cloud SQL instances, IAM Roles and Security Permissions, etc., must belong to a project. We&rsquo;ll need to <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>Create a GCP Project</a> in order to finished the setup steps.</p><p>Before continuing, we need to enable the following APIs</p><ul><li>Enable <a href=https://console.developers.google.com/apis/library/cloudresourcemanager.googleapis.com>Cloud Resource Manager API</a></li><li>Enable <a href=https://console.cloud.google.com/apis/library/iam.googleapis.com>Identity And Access Management (IAM) API</a></li></ul><h3 id=cli-access-for-users>CLI Access for Users<a class=td-heading-self-link href=#cli-access-for-users aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Initialize gcloud CLI and login with your Google Account</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># This command will open a browser window for authentication.</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># It will also prompt you to choose or create a default project and region/zone.</span>
</span></span><span style=display:flex><span>  gcloud init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Alternatively, to just log in (if gcloud is already initialized):</span>
</span></span><span style=display:flex><span>  gcloud auth login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># To list authenticated accounts:</span>
</span></span><span style=display:flex><span>  gcloud auth list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># To set your default project:</span>
</span></span><span style=display:flex><span>  gcloud config <span style=color:#204a87>set</span> project *<span style=color:#ce5c00;font-weight:700>[</span>YOUR_PROJECT_ID<span style=color:#ce5c00;font-weight:700>]</span>*
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=service-account-setup-programmatic-access>Service Account Setup (Programmatic Access)<a class=td-heading-self-link href=#service-account-setup-programmatic-access aria-label="Heading self-link"></a></h2><p>For applications, scripts, or CI/CD pipelines that need to interact with GCP APIs programmatically, you should use Service Accounts. Avoid using user credentials for programmatic access.</p><h3 id=programmatic-steps>Programmatic Steps<a class=td-heading-self-link href=#programmatic-steps aria-label="Heading self-link"></a></h3><p>You can perform service account setup and permissions assignment using the Google Cloud CLI (<code>gcloud</code>). The following steps mirror the console steps above:</p><ul class="nav nav-tabs justify-content-end" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=shell aria-controls=tabs-01-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li><li class=nav-item><button class=nav-link id=tabs-01-03-tab data-bs-toggle=tab data-bs-target=#tabs-01-03 role=tab data-td-tp-persist=hcl aria-controls=tabs-01-03 aria-selected=false>
<span style=vertical-align:middle><img src=https://cdn.simpleicons.org/terraform/5835CC alt="Terraform icon" style=height:1em;vertical-align:middle;margin-right:.3em></span>
Terraform</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a new service account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/creating-managing-service-accounts#gcloud</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud iam service-accounts create example-service-account <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --description<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Example Service Account for automation&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --display-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Example Service Account&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Grant roles to the service account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/granting-roles-to-service-accounts#gcloud</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountUser&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (Optional) Grant additional roles as needed</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example: Security Admin</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gcloud projects add-iam-policy-binding $GCP_PROJECT_ID \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --member=&#34;serviceAccount:example-service-account@${GCP_PROJECT_ID}.iam.gserviceaccount.com&#34; \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --role=&#34;roles/iam.securityAdmin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Impersonate the service account for short-lived credentials</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/docs/authentication/use-service-account-impersonation#gcloud</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud config <span style=color:#204a87>set</span> auth/impersonate_service_account example-service-account@<span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove IAM policy bindings for the service account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (Repeat for each role previously assigned)</span>
</span></span><span style=display:flex><span>gcloud projects remove-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountUser&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud projects remove-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (Optional) Remove any additional roles as needed</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gcloud projects remove-iam-policy-binding $GCP_PROJECT_ID \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --member=&#34;serviceAccount:example-service-account@${GCP_PROJECT_ID}.iam.gserviceaccount.com&#34; \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --role=&#34;roles/iam.securityAdmin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete the service account</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts delete <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  example-service-account@<span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-03 role=tabpanel aria-labelled-by=tabs-01-03-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HCL data-lang=HCL><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## ---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## GCP PROVIDER
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Configures the GCP provider with OIDC Connect via ENV Variables.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## ---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>provider</span> <span style=color:#4e9a06>&#34;google&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tokengen&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## GCP SERVICE ACCOUNT MODULE
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## This module provisions a GCP service account along with associated roles and security groups.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Parameters:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `IMPERSONATE_SERVICE_ACCOUNT_EMAIL`: Existing GCP service account email to impersonate for new SA creation.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `new_service_account_name`: New service account name.\\
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `role_list`: List of roles to assign to the new service account.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Providers:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `google.tokengen`: Alias for the GCP provider for generating service accounts.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>module</span> <span style=color:#4e9a06>&#34;gcp_service_account&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;../&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  IMPERSONATE_SERVICE_ACCOUNT_EMAIL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>var</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>IMPERSONATE_SERVICE_ACCOUNT_EMAIL</span>
</span></span><span style=display:flex><span><span style=color:#000>  new_service_account_name</span>          <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;example-service-account&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  providers</span> <span style=color:#ce5c00;font-weight:700>=</span> {
</span></span><span style=display:flex><span><span style=color:#000>    google.tokengen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>google</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>tokengen</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><p>For more details, see the <a href=https://cloud.google.com/sdk/gcloud/reference/iam/service-accounts/>gcloud CLI documentation</a>.</p><h3 id=console>Console<a class=td-heading-self-link href=#console aria-label="Heading self-link"></a></h3><p>Create a <a href=https://cloud.google.com/iam/docs/service-accounts-create>New Service Account</a> in your GCP project, and give it a descriptive name and ID. Once created, make sure to <a href=https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role>Grant Principal Access</a> to the Service Account using your project account with the following roles:</p><ul><li>Service Account Token Creator</li><li>Service Account User</li></ul><p>This will allow users to authenticate and interact with GCP using the Service Account with controlled permissions.</p><h4 id=grant-permissions-iam-roles--conditions>Grant Permissions (IAM Roles & Conditions)<a class=td-heading-self-link href=#grant-permissions-iam-roles--conditions aria-label="Heading self-link"></a></h4><p>Grant the necessary IAM roles to this service account on the specific resources it needs to access follow the principle of least privilege. Under <strong>Permissions</strong>, and selecting <strong>Manage Access</strong> in the Service Account view, is where we will be able to add IAM Roles. For our example, we&rsquo;ll assign the following roles to help manage later steps:</p><ul><li>Security Admin</li><li>Service Account Admin</li></ul><p>More discovery and evaluation is needed on hardening security with IP restrictions using <a href=https://cloud.google.com/iam/docs/conditions-overview>IAM Conditions</a> and <a href=https://cloud.google.com/iam/docs/conditions-attribute-reference#request>Condition Attributes</a>. Currently, only organizations are able to create <a href=https://cloud.google.com/access-context-manager/docs/create-custom-access-level>Access-Context-Managers</a> to manage IAM Condition level IP restrictions.</p><p>It&rsquo;s encourage to <a href=https://cloud.google.com/resource-manager/docs/organization-policy/restricting-service-accounts#disable_service_account_key_creation>Disable Service Account Key Creation</a> with Organizational IAM Policies, but this is only available to GCP projects belonging to an Organization.</p><h4 id=setup-short-lived-keys-with-service-account-impersonation>Setup Short-Lived Keys with Service Account Impersonation<a class=td-heading-self-link href=#setup-short-lived-keys-with-service-account-impersonation aria-label="Heading self-link"></a></h4><p><a href=https://cloud.google.com/docs/authentication/use-service-account-impersonation>Service Account Impersonation</a> in GCP allows a principal (like a user or another service account) to temporarily assume the identity and permissions of a specific service account. This is achieved by granting the principal the &ldquo;Service Account Token Creator&rdquo; role on the target service account.</p><p>Instead of directly using the target service account&rsquo;s long-lived keys, the principal requests short-lived credentials for that service account, effectively acting as that service account for a limited time and with its defined permissions. This is a security best practice as it avoids the need to distribute service account keys and allows for more granular and temporary access control.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-42e62deeade8d37e64b220e78934a681>1.5.2 - Terraform Backend</h1><div class=lead>GCP - Configuring Google Cloud Storage (GCS) as a remote backend for Terraform state, an alternative to Terraform Cloud workspaces.</div><h1 id=terraform-backend-with-google-cloud-storage>Terraform Backend with Google Cloud Storage<a class=td-heading-self-link href=#terraform-backend-with-google-cloud-storage aria-label="Heading self-link"></a></h1><p>Using Google Cloud Storage (GCS) as the backend for Terraform state is a robust and common practice for managing infrastructure as code on GCP. By storing Terraform state in a GCS bucket, teams can benefit from Google Cloud&rsquo;s strong security features, such as encryption at rest and in transit, fine-grained access control with IAM, and object versioning for state history and recovery. GCS provides a highly durable and available storage solution, ensuring that Terraform state is consistently accessible. This setup allows teams to use IAM Service Accounts and impersonation to manage access to the state files, adhering to the principle of least privilege, similar to using IAM Roles in other cloud environments. Furthermore, it integrates well with other GCP services and CI/CD pipelines for automated and monitored Terraform workflows.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p ~/development/test/example_gcp_tf_backend
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_gcp_tf_backend
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure GCloud CLI Application-Default-Credentials</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/docs/authentication/application-default-credentials</span>
</span></span><span style=display:flex><span>gcloud auth application-default login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Setting environment variables</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Or set manually: &#34;your-gcp-project-id&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_REGION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;us-central1&#34;</span> <span style=color:#8f5902;font-style:italic># Choose your preferred region</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>TERRAFORM_GCS_BUCKET_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>-tfstate-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 4<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> <span style=color:#8f5902;font-style:italic># Must be globally unique</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>TERRAFORM_GCS_PREFIX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;sandbox/terraform.tfstate&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Grant StorageAdmin Role to Service Account</span>
</span></span><span style=display:flex><span>gsutil iam ch serviceAccount:<span style=color:#000>$GCP_SA_EMAIL</span>:objectAdmin gs://<span style=color:#4e9a06>${</span><span style=color:#000>TERRAFORM_GCS_BUCKET_NAME</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a GCS Bucket for Terraform State</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/storage/docs/creating-buckets#gsutil</span>
</span></span><span style=display:flex><span>gsutil mb -p <span style=color:#000>$GCP_PROJECT_ID</span> -l <span style=color:#000>$GCP_REGION</span> gs://<span style=color:#000>$TERRAFORM_GCS_BUCKET_NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable Object Versioning on the Bucket (Crucial for state history and preventing accidental data loss)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/storage/docs/object-versioning#gsutil</span>
</span></span><span style=display:flex><span>gsutil versioning <span style=color:#204a87>set</span> on gs://<span style=color:#000>$TERRAFORM_GCS_BUCKET_NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure Terraform</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; backend.conf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>bucket                      = &#34;$TERRAFORM_GCS_BUCKET_NAME&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>prefix                      = &#34;$TERRAFORM_GCS_PREFIX&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; terraform.tfvars
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>gcp_project_id = &#34;$GCP_PROJECT_ID&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>gcp_region     = &#34;$GCP_REGION&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; variables.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;gcp_project_id&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;GCP Project ID for resource deployment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;gcp_region&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;GCP Region for resource deployment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; main.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>/* GCS managed terraform state - configuration is in backend.conf */
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>terraform {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  required_providers {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    google = {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      source  = &#34;hashicorp/google&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version = &#34;~&gt; 5.0&#34; # Specify a version constraint
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  backend &#34;gcs&#34; {} // Configuration will be loaded from backend.conf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>/* Google Cloud Provider Configuration */
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>provider &#34;google&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  project = var.gcp_project_id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  region  = var.gcp_region
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  // Terraform will use Application Default Credentials (ADC) of the user running it.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  // For CI/CD or specific service account usage for resource management,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  // you can configure &#39;credentials = file(&#34;path/to/sa-key.json&#34;)&#39; or use Workload Identity Federation.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Test Terraform</span>
</span></span><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># terraform apply --auto-approve # (Optional: Add a dummy resource to main.tf to test apply)</span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure environment variables are set from the Create step</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Tear Down Terraform managed resources (if any were created by &#39;terraform apply&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_gcp_tf_backend
</span></span><span style=display:flex><span>terraform destroy --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete GCS Bucket and all its objects (including versions)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The &#39;-m&#39; flag enables multi-threaded/multi-processing operations.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The &#39;-r&#39; flag enables recursive deletion.</span>
</span></span><span style=display:flex><span>gsutil -m rm -r gs://<span style=color:#000>$TERRAFORM_GCS_BUCKET_NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Clean up local Terraform files</span>
</span></span><span style=display:flex><span>rm -f backend.conf main.tf variables.tf terraform.tfvars terraform.tfstate*
</span></span><span style=display:flex><span>rm -rf .terraform .terraform.lock.hcl
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><h3 id=create-gcs-bucket>Create GCS Bucket<a class=td-heading-self-link href=#create-gcs-bucket aria-label="Heading self-link"></a></h3><p>Create a <a href=https://cloud.google.com/storage/docs/creating-buckets>GCS Bucket</a> for the terraform <code>tfstate</code>. This will reduce the chance of sensitive data being committed to source. Configure the Bucket to have <strong>Standard Storage Classification</strong>, and <strong>Uniform Access Control</strong>. Enabling <a href=https://cloud.google.com/storage/docs/using-object-versioning>GCS Bucket Versioning</a> is critical for state management - to allow tracking of changes and enable recovery/ roll-back functionality.</p><h3 id=grant-service-account-permissions-to-gcs-bucket>Grant Service Account Permissions to GCS Bucket<a class=td-heading-self-link href=#grant-service-account-permissions-to-gcs-bucket aria-label="Heading self-link"></a></h3><p>Configure the newly created GCS Bucket for terraform <code>tfstate</code> to grant Service Account access to read/write following the <a href=https://cloud.google.com/storage/docs/access-control/using-iam-permissions>Bucket IAM Policies</a> guide. Ensure to assign the Service Account with <strong>Storage Object Admin</strong> role.</p><h3 id=configure-terraform-backend>Configure Terraform Backend<a class=td-heading-self-link href=#configure-terraform-backend aria-label="Heading self-link"></a></h3><p>Create a <code>backend.conf</code> file to configure <a href=https://developer.hashicorp.com/terraform/language/backend/gcs>GCS Terraform Backend</a>. Input the following contents into the file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#000>bucket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_GCS_BUCKET_NAME]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_GCS_BUCKET_PREFIX]&#34;</span>
</span></span></code></pre></div><p>Now Terraform will be configured to store its state in GCS. Also, we&rsquo;ve omitted configuration <code>impersonate_service_account</code>, as the <a href=https://cloud.google.com/docs/authentication/application-default-credentials>Google Application Default Credentials</a> (ADC) will be automatically impersonating our Service Account when we configure <code>gcloud cli</code> impersonation.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># From New Account Setup</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gcloud config set auth/impersonate_service_account $GCP_SA_EMAIL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud auth application-default login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span>terraform apply --auto-approve
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9bcd402fa4d9352b990c1fe87d0421ce>1.5.3 - OpenID Connect</h1><div class=lead>GCP - Modernized Security for GitOps & CI/CD with GitHub Actions using Workload Identity Federation.</div><h1 id=openid-connect-oidc-with-github-actions-and-gcp-workload-identity-federation>OpenID Connect (OIDC) with GitHub Actions and GCP Workload Identity Federation<a class=td-heading-self-link href=#openid-connect-oidc-with-github-actions-and-gcp-workload-identity-federation aria-label="Heading self-link"></a></h1><p>Google Cloud&rsquo;s <a href=https://cloud.google.com/iam/docs/workload-identity-federation>Workload Identity Federation</a> allows identities from external OpenID Connect (OIDC) providers, like GitHub Actions, to impersonate Google Cloud service accounts. This enables your GitHub Actions workflows to securely access GCP resources without needing to manage or store long-lived service account keys in GitHub. Instead, workflows obtain short-lived access tokens, enhancing security and simplifying credential management for CI/CD pipelines.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p ~/development/test/example_gcp_oidc
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_gcp_oidc
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 0. Prerequisites &amp; Configuration</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure gcloud CLI is installed, authenticated, and configured with a default project.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure GitHub CLI (gh) is installed and authenticated if using it to get repo details.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud projects describe <span style=color:#000>$GCP_PROJECT_ID</span> --format<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;value(projectNumber)&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_OWNER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;your-github-username-or-org&#34;</span> <span style=color:#8f5902;font-style:italic># Replace with your GitHub username or organization</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_REPO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;your-github-repo-name&#34;</span>    <span style=color:#8f5902;font-style:italic># Replace with your GitHub repository name</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_USER_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value account<span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Your GCP user email, for optional SA impersonation</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>POOL_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;github-pool-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 2<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>PROVIDER_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;github-provider-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 2<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 1. Grant Workload Identity Pool Permissions to Service Account</span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:</span><span style=color:#000>$GCP_SA_EMAIL</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.workloadIdentityPoolAdmin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 1. Create a Workload Identity Pool</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/create</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools create <span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --display-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;GitHub Actions Pool&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --description<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Pool for GitHub Actions OIDC federation&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 2. Create a Workload Identity Provider in the Pool for GitHub</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/create</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools providers create-oidc <span style=color:#000>$PROVIDER_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --workload-identity-pool<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --issuer-uri<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;https://token.actions.githubusercontent.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --allowed-audiences<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;https://iam.googleapis.com/projects/</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/locations/global/workloadIdentityPools/</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/providers/</span><span style=color:#4e9a06>${</span><span style=color:#000>PROVIDER_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --display-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;GitHub OIDC Provider&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --description<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Provider for GitHub Actions&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --attribute-mapping<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository,attribute.repository_owner=assertion.repository_owner,attribute.ref=assertion.ref&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --attribute-condition<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;assertion.repository == &#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39; &amp;&amp; assertion.ref == &#39;refs/heads/main&#39;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The --attribute-condition above restricts this provider to only issue credentials for tokens from the specified repo and main branch.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># You can make it broader (e.g., only `assertion.repository_owner == &#39;${GH_OWNER}&#39;`) and control access via IAM conditions on the service account binding.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 3. Create a dedicated OIDC SA &amp; Grant necessary permissions on GCP resources</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Adjust the role (e.g., roles/iam.securityReviewer, roles/run.invoker, roles/editor) based on what your workflow needs to do.</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_POOL_SA_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span>-sa
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_POOL_SA_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_POOL_SA_ID</span><span style=color:#4e9a06>}</span>@<span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>gcloud iam service-accounts create <span style=color:#000>$GCP_POOL_SA_ID</span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_POOL_SA_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/storage.admin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 4. Allow GitHub Actions (via the Workload Identity Provider) to impersonate the Service Account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This binds the GitHub OIDC subject (filtered by the provider&#39;s attribute-condition) to the SA.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The subject from GitHub OIDC token for a specific repo and ref is `repo:OWNER/REPO_NAME:ref:refs/heads/main`</span>
</span></span><span style=display:flex><span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;repo:</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:ref:refs/heads/main&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud iam service-accounts add-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.workloadIdentityUser&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;principal://iam.googleapis.com/projects/</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/locations/global/workloadIdentityPools/</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/subject/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 5. (Optional) Allow your GCP user to impersonate the Service Account for testing/local development</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts add-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_USER_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure environment variables from the Create step are set, or re-define them:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. (Optional) Remove GCP user&#39;s permission to impersonate the Service Account</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts remove-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_USER_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Remove GitHub Actions&#39; permission to impersonate the Service Account</span>
</span></span><span style=display:flex><span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;repo:</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:ref:refs/heads/main&#34;</span> <span style=color:#8f5902;font-style:italic># Reconstruct if not set</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts remove-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.workloadIdentityUser&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;principal://iam.googleapis.com/projects/</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/locations/global/workloadIdentityPools/</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/subject/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Remove roles granted to the Service Account (example: roles/iam.securityReviewer)</span>
</span></span><span style=display:flex><span>gcloud projects remove-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_POOL_SA_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/storage.admin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. Delete the Service Account</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts delete <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. Delete the Workload Identity Provider</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools providers delete <span style=color:#000>$PROVIDER_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --workload-identity-pool<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 6. Delete the Workload Identity Pool</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools delete <span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><h3 id=1-create-workload-identity-pool>1. Create Workload Identity Pool<a class=td-heading-self-link href=#1-create-workload-identity-pool aria-label="Heading self-link"></a></h3><p>Start by creating a new <a href=https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers>Workload Identity Pool</a> - provide a name like <code>github-actions-pool</code>. The Workload Identity Pool (WIP) will centralize the collection of possible OIDC providers we can configure to provide least-priviledged access into our GCP Project.</p><h3 id=2-add-a-provider-to-the-pool-for-github-actions>2. Add a Provider to the Pool for GitHub Actions<a class=td-heading-self-link href=#2-add-a-provider-to-the-pool-for-github-actions aria-label="Heading self-link"></a></h3><p>After creating our WIP, we can now <a href=https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers#manage-providers>Manage Providers</a>. Setup instructions for <a href=https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-google-cloud-platform#adding-a-google-cloud-workload-identity-provider>OIDC between GCP and Github</a> are sparse, but more cross-platform details can be found in the <a href=https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect#configuring-the-subject-in-your-cloud-provider>Security Hardening Guide</a>. Use the following details to setup Github OIDC provider in our WIP.</p><ul><li><strong>Issuer (URL)</strong> Enter <code>https://token.actions.githubusercontent.com</code>.</li><li><strong>Attribute Mapping</strong> details/ maps the <a href=https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token>OIDC Token Claims</a> for CEL expression filtering<ul><li><code>google.subject</code>: <code>assertion.sub</code></li><li><code>attribute.actor</code>: <code>assertion.actor</code></li><li><code>attribute.aud</code>: <code>assertion.aud</code></li><li><code>attribute.repository</code>: <code>assertion.repository</code> (e.g., <code>your-owner/your-repo</code>)</li><li><code>attribute.repository_owner</code>: <code>assertion.repository_owner</code></li><li><code>attribute.ref</code>: <code>assertion.ref</code> (e.g., <code>refs/heads/main</code>)</li><li><code>attribute.environment</code>: <code>assertion.environment</code> (if you use GitHub environments)</li></ul></li><li><strong>Attribute Condition (Optional but Recommended)</strong>:<ul><li>This CEL expression filters which GitHub tokens are allowed by this provider.</li><li>Example for a specific repository and its main branch:
<code>assertion.repository == 'YOUR_GITHUB_OWNER/YOUR_GITHUB_REPO' && assertion.ref == 'refs/heads/main'</code></li><li>Example for any repository under a specific owner:
<code>assertion.repository_owner == 'YOUR_GITHUB_OWNER'</code></li></ul></li></ul><h3 id=3-create-service-accounts--grant-workload-identity-user-role>3. Create Service Account(s) & Grant Workload Identity User Role<a class=td-heading-self-link href=#3-create-service-accounts--grant-workload-identity-user-role aria-label="Heading self-link"></a></h3><p>You&rsquo;ll need one or more <a href=https://cloud.google.com/iam/docs/service-accounts-create>New Service Account</a> that your GitHub Actions workflows will impersonate. Configure the Workload Identity Pool (i.e., specific GitHub Actions workflows) with <a href=https://cloud.google.com/iam/docs/workload-identity-federation#access_management>WIP Access Management</a> to impersonate the service account(s). <a href=https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role>Grant Principal Access</a> to the Service Account with either of the following Principals:</p><ul><li>To allow workflows from a specific repository and specific branch (e.g., <code>main</code>):
<code>principal://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/subject/repo:GITHUB_OWNER/GITHUB_REPO_NAME:ref:refs/heads/main</code></li><li>To allow workflows from a specific repository and specific environment (e.g., <code>production</code>):
<code>principal://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/subject/repo:GITHUB_OWNER/GITHUB_REPO_NAME:environment:production</code>
<strong>Replace <code>PROJECT_NUMBER</code>, <code>POOL_ID</code>, <code>PROVIDER_ID</code>, <code>GITHUB_OWNER</code>, <code>GITHUB_REPO_NAME</code> with your actual values.</strong></li></ul><p><strong>Assign roles</strong>: <strong>Workload Identity User</strong> (<code>roles/iam.workloadIdentityUser</code>) to allow for Workload Identity Federation impersonation with the Service Account. Lastly, bind the necessary roles with least priviledges to operate. Repeat for other service accounts and GitHub principal combinations as needed. For example:
* <code>github-cicd-read-sa</code> might be impersonable by <code>repo:ORG/REPO:ref:refs/heads/*</code> (any branch).
* <code>github-cicd-deploy-sa</code> might be impersonable by <code>repo:ORG/REPO:ref:refs/heads/main</code> or <code>repo:ORG/REPO:environment:production</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7e8e3f1008421ab9c045483af58da1c1>2 - Data Ingestion & Data Lake</h1><div class=lead>Overview of data ingestion pattern and best practices for modern data platforms.</div><h2 id=what-is-data-ingestion>What is Data Ingestion?<a class=td-heading-self-link href=#what-is-data-ingestion aria-label="Heading self-link"></a></h2><p>The initial process of collecting and transporting data from various sources into a storage or processing system, such as a data warehouse, data lake, or analytics platform. It is the foundational step in building data pipelines, enabling organizations to centralize, analyze, and derive insights from their data. Common terminology in this area include:</p><ul><li><strong>Data Ingestion:</strong> The general process of moving data from source systems to a target system.</li><li><strong>Data Lake Ingestion:</strong> Specifically refers to loading data into a data lake, which is a centralized repository for storing raw, unstructured, or structured data at scale.</li><li><strong>Data Hydration:</strong> Sometimes used interchangeably with ingestion, this term emphasizes the process of populating a data store (often a data lake or warehouse) with fresh data.</li><li><strong>Data Pipeline:</strong> A broader term that includes ingestion, transformation, and loading (ETL/ELT) steps.</li><li><strong>Source-to-Target:</strong> Describes the end-to-end flow of data from its origin (source) to its destination (target), often with mapping and transformation logic.</li></ul><h2 id=architecture>Architecture<a class=td-heading-self-link href=#architecture aria-label="Heading self-link"></a></h2><p>A cloud-agnostic pattern for data lake ingestion leverages serverless functions to move data from diverse sources into a centralized data lake, regardless of the underlying cloud provider (AWS, Azure, GCP, etc.). This approach enables organizations to build scalable, event-driven, and cost-effective ingestion pipelines that are portable across cloud platforms.</p><p>A well defined Landing Zone pattern is also strongly encouraged to keep data storage standardized and consistent in the Data Lake. Example of possible landing zones could include Quarantine, Sandbox, Archive, Staging, Encrypted, and Anonymized. For more, see Microsoft’s guidance on <a href=https://learn.microsoft.com/en-us/azure/architecture/example-scenario/data/data-lake>Data Lake Zones</a>.</p><p>We recommend adopting the <a href=https://www.databricks.com/glossary/medallion-architecture>Medallion Architecture</a> landing zones, popularized by Databricks, for their clarity, simplicity, and support for robust data governance and analytics workflows.</p><h3 id=pattern-overview>Pattern Overview<a class=td-heading-self-link href=#pattern-overview aria-label="Heading self-link"></a></h3><pre class=mermaid>architecture-beta
    title Data Ingestion &amp; Data Lake Architecture
    group source(icon-park-solid:system)[Source System]
    service sourcedata(iconoir:raw-format)[Source Data] in source

    group cloud(material-symbols:cloud-outline)[Data Ingestion]
    service cloudtrigger(tabler:timeline-event-plus)[Event Trigger] in cloud
    service cloudevent(carbon:function)[Event Function] in cloud
    service datalakebronze(carbon:data-blob)[Bronze of Raw] in cloud
    service datalakesilver(carbon:data-blob)[Silver of Cleaned] in cloud
    service datalakegold(carbon:data-blob)[Gold of Ready] in cloud

    junction junctionCenter
    junction junctionTop
    junction junctionBottom
    junction junctionRight
    
    sourcedata{group}:R -- L:cloudtrigger{group}
    cloudtrigger:R -- L:cloudevent
    cloudevent:R -- L:junctionRight
    
    junctionRight:R -- T:junctionTop
    junctionTop:R -- L:datalakebronze

    junctionRight:R -- L:junctionCenter
    datalakebronze:B -- T:datalakesilver

    datalakesilver:B -- T:datalakegold</pre><p>This architecture-style diagram shows how multiple source systems feed into an event-driven, serverless ingestion layer, which then lands data in a <em>medallion-zoned</em> data lake.</p><ol><li><strong>Source Systems:</strong> Data originates from various sources such as databases, APIs, SaaS platforms, or file drops.</li><li><strong>Event Trigger:</strong> The arrival of new data (e.g., file upload, message in a queue, API call) triggers a serverless function.</li><li><strong>Serverless Ingestion Function:</strong> The function (e.g., AWS Lambda, Azure Function, Google Cloud Function) extracts the data from the source, performs basic validation or formatting, and writes it to the data lake&rsquo;s landing zone.</li><li><strong>Landing Zone (Bronze/Raw):</strong> Data is first stored in a &ldquo;Bronze&rdquo; or &ldquo;Raw&rdquo; zone within the data lake. This zone contains untransformed, immutable copies of the ingested data, preserving its original fidelity for audit and replay purposes.</li><li><strong>Medallion Architecture:</strong> Downstream processes (often also serverless or orchestrated jobs) read from the Bronze zone, apply cleansing, transformation, and enrichment, and write the results to Silver (cleaned/validated) and Gold (business-ready/aggregated) zones. This &ldquo;medallion&rdquo; pattern supports data quality, lineage, and incremental processing.</li></ol><h3 id=key-characteristics>Key Characteristics<a class=td-heading-self-link href=#key-characteristics aria-label="Heading self-link"></a></h3><ul><li><strong>Cloud Agnostic:</strong> Uses standard serverless and object storage primitives available in all major clouds.</li><li><strong>Event-Driven:</strong> Ingestion is triggered by events, enabling real-time or near-real-time data movement.</li><li><strong>Scalable & Cost-Efficient:</strong> Serverless functions scale automatically and incur costs only when running.</li><li><strong>Modular/ Extensible:</strong> Easilly adoptable across wide range of sources and integration for ETL or ELT style source to target transformations.</li></ul><p>This architecture is widely adopted for modern data platforms, enabling organizations to build robust, maintainable, and future-proof data ingestion pipelines.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c2113c28ba0a1e1c4c6ea99c61ab177b>2.1 - AWS | Data Ingestion & Data Lake</h1><div class=lead>Overview of data ingestion pattern and best practices in AWS.</div><h2 id=infrastructure>Infrastructure<a class=td-heading-self-link href=#infrastructure aria-label="Heading self-link"></a></h2><p>This deployment provisions a cloud-native, event-driven data ingestion pipeline on AWS, following the medallion architecture (Bronze/Silver/Gold zones) as described in the architecture overview. The infrastructure is modular and reusable, leveraging the Terraform modules found in <a href>AWS HTTP Trigger</a> repo.</p><h3 id=s3-buckets>S3 Buckets<a class=td-heading-self-link href=#s3-buckets aria-label="Heading self-link"></a></h3><p><a href=https://aws.amazon.com/s3/>S3 Cloud Storage</a> buckets are created to form the medallion landing zones for our Data Lake. The buckets are configured with the following minumal security and retention requirements:</p><ul><li>Versioning for data lineage and recovery.</li><li>Server-side encryption using AWS KMS.</li><li>Lifecycle policies for cost management and compliance.</li><li>Public access blocks for security.</li></ul><h3 id=sns-topic>SNS Topic<a class=td-heading-self-link href=#sns-topic aria-label="Heading self-link"></a></h3><p>The AWS <a href=https://aws.amazon.com/sns/>Simple Notification Services</a> is utilized to mesh together data ingestion events with <strong>subscribed</strong> Lambda functions. The SNS topic also supports dead-letter queue (DLQ) - capturing failed Lambda executions and notifications.</p><h3 id=kms-encrypted-secrets>KMS Encrypted Secrets<a class=td-heading-self-link href=#kms-encrypted-secrets aria-label="Heading self-link"></a></h3><p>We provision a custom encryption key for encrypting S3 bucket data and SNS Messages - with policies set to secure access with trusted parties via automatic key rotation.</p><h3 id=aws-lambda-function-serverless-ingestion>AWS Lambda Function (Serverless Ingestion)<a class=td-heading-self-link href=#aws-lambda-function-serverless-ingestion aria-label="Heading self-link"></a></h3><p>A Lambda function is deployed to process new data and hydrate our data lake. Lambda Layers are used to package dependencies (e.g., s3fs, pyarrow), and the function is configured with Environment variables and IAM roles for secure access to S3 and other AWS services.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://example.org/mail aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Twitter aria-label=Twitter><a target=_blank rel=noopener href=https://example.org/twitter aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Stack Overflow" aria-label="Stack Overflow"><a target=_blank rel=noopener href=https://example.org/stack aria-label="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/docsy aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://example.org/slack aria-label=Slack><i class="fab fa-slack"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Developer mailing list" aria-label="Developer mailing list"><a target=_blank rel=noopener href=https://example.org/mail aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2025
<span class=td-footer__authors>Docsy Authors | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/docs_blog/js/main.min.115f19af160d1221e5d7ad0bb0ea2960832ce0857063f349661781f47be40740.js integrity="sha256-EV8ZrxYNEiHl160LsOopYIMs4IVwY/NJZheB9HvkB0A=" crossorigin=anonymous></script>
<script defer src=/docs_blog/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script>
<script src=/docs_blog/js/tabpane-persist.js></script></body></html>