<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://openvers.github.io/docs_blog/docs/cloud_setup/gcp/><link rel=alternate type=application/rss+xml href=https://openvers.github.io/docs_blog/docs/cloud_setup/gcp/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/docs_blog/favicons/favicon.ico><link rel=apple-touch-icon href=/docs_blog/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/docs_blog/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/docs_blog/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/docs_blog/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/docs_blog/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/docs_blog/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/docs_blog/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/docs_blog/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/docs_blog/favicons/android-192x192.png sizes=192x192><title>Google Cloud Platform (GCP) | OpenVERS</title><meta name=description content="GCP - A suite of cloud computing services provided by Google, offering a wide array of tools for data practitioners."><meta property="og:title" content="Google Cloud Platform (GCP)"><meta property="og:description" content="GCP - A suite of cloud computing services provided by Google, offering a wide array of tools for data practitioners."><meta property="og:type" content="website"><meta property="og:url" content="https://openvers.github.io/docs_blog/docs/cloud_setup/gcp/"><meta property="og:site_name" content="OpenVERS"><meta itemprop=name content="Google Cloud Platform (GCP)"><meta itemprop=description content="GCP - A suite of cloud computing services provided by Google, offering a wide array of tools for data practitioners."><meta name=twitter:card content="summary"><meta name=twitter:title content="Google Cloud Platform (GCP)"><meta name=twitter:description content="GCP - A suite of cloud computing services provided by Google, offering a wide array of tools for data practitioners."><link rel=preload href=/docs_blog/scss/main.min.44e056411013bf8f18a255176cfb0420600587168abb56228837c1f35a8df1c0.css as=style><link href=/docs_blog/scss/main.min.44e056411013bf8f18a255176cfb0420600587168abb56228837c1f35a8df1c0.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/docs_blog/><span class="navbar-brand__logo navbar-logo"><svg width="128" height="128" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><title>OpenVERS Icon - White Background</title><desc>A dimensional icon for Open Data Versatility with a white background circle. It features an open deep blue ring and three bright teal lines with an enhanced extruded effect suggesting depth.</desc><style>.fill-none{fill:none}.stroke-linecap-round{stroke-linecap:round}.circle-main-style{stroke:#3b4856;stroke-width:10}.circle-depth-style{stroke:#072a5c;stroke-width:10}.line-main-style{stroke:#009cff;stroke-width:8}.line-depth-style{stroke:#007a8a;stroke-width:8}.line-accent-shadow-style{stroke:#005f6b;stroke-width:2}.bg-circle-style{fill:#fff}</style><circle class="bg-circle-style" cx="50" cy="50" r="50"/><path d="M86.5 51.5a35 35 0 11-35-35" class="fill-none stroke-linecap-round circle-depth-style"/><path d="M85 50A35 35 0 1150 15" class="fill-none stroke-linecap-round circle-main-style"/><g class="fill-none stroke-linecap-round line-accent-shadow-style"><line x1="52.5" y1="52.5" x2="79.5" y2="25.5"/><line x1="52.5" y1="52.5" x2="26.5" y2="37.5"/><line x1="52.5" y1="52.5" x2="52.5" y2="82.5"/></g><g class="fill-none stroke-linecap-round line-depth-style"><line x1="51.5" y1="51.5" x2="78.5" y2="24.5"/><line x1="51.5" y1="51.5" x2="25.5" y2="36.5"/><line x1="51.5" y1="51.5" x2="51.5" y2="81.5"/></g><g class="fill-none stroke-linecap-round line-main-style"><line x1="50" y1="50" x2="77" y2="23"/><line x1="50" y1="50" x2="24" y2="35"/><line x1="50" y1="50" x2="50" y2="80"/></g></svg></span><span class=navbar-brand__name>OpenVERS</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs_blog/about/><span>About</span></a></li><li class=nav-item><a class=nav-link href=/docs_blog/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/docs_blog/community/><span>Community</span></a></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs_blog/docs/cloud_setup/gcp/>Return to the regular view of this page</a>.</p></div><h1 class=title>Google Cloud Platform (GCP)</h1><div class=lead>GCP - A suite of cloud computing services provided by Google, offering a wide array of tools for data practitioners.</div><ul><li>1: <a href=#pg-0d86a12c9c001657acfee1fd19a167bc>Account Setup</a></li><li>2: <a href=#pg-42e62deeade8d37e64b220e78934a681>Terraform Backend</a></li><li>3: <a href=#pg-9bcd402fa4d9352b990c1fe87d0421ce>OpenID Connect</a></li></ul><div class=content><p>GCP (Google Cloud Platform) is a comprehensive suite of cloud computing services offered by Google. It provides a wide array of services, including computing, storage, databases, big data analytics, machine learning, and more. GCP enables data practitioners to build, deploy, and manage applications and workloads in a flexible, scalable, and secure environment. When setting up GCP for the first time, focusing on security is paramount for data practitioners to ensure the confidentiality and integrity of their data and applications. Without robust security measures, sensitive information can be vulnerable to unauthorized access, and for hobbyists, compromised credentials can lead to malicious activities and unexpected costs. It&rsquo;s crucial to implement security best practices, such as Identity and Access Management (IAM), strong authentication and authorization controls, and network security (VPC, Firewalls) to safeguard against potential threats. By prioritizing security from the start, data practitioners can avoid common pitfalls like misconfigured Cloud Storage buckets, overly permissive IAM roles, and compromised service account keys.</p><h1 id=getting-started>Getting Started<a class=td-heading-self-link href=#getting-started aria-label="Heading self-link"></a></h1><p>The <strong>gcloud CLI</strong> (Google Cloud CLI) is a powerful command-line tool that allows users to interact with Google Cloud services. It enables you to manage and automate various tasks, such as creating and managing resources, deploying applications, and configuring services. Please visit the <a href=https://cloud.google.com/sdk/docs/install>Official Google Cloud CLI Installation Instructions</a> to review the installation steps. For enhanced development workflows, consider using <a href=https://cloud.google.com/code>Cloud Code</a>, which provides IDE extensions for VS Code and JetBrains IDEs to help write, debug, and deploy applications to Google Cloud.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0d86a12c9c001657acfee1fd19a167bc>1 - Account Setup</h1><div class=lead>GCP - New Account Setup with Critical Security Measures Applied as First Priority.</div><h2 id=setup-new-account>Setup New Account<a class=td-heading-self-link href=#setup-new-account aria-label="Heading self-link"></a></h2><p>Creating a Google Cloud Platform (GCP) presence starts with a Google Account. If you don&rsquo;t have one, you can create one for free. You&rsquo;ll then create a &ldquo;Project&rdquo; within GCP to organize your resources. Billing is managed through a &ldquo;Billing Account&rdquo; linked to your projects. More details can be found at the <a href=https://cloud.google.com/docs/get-started>GCP Get Started page</a>.
It&rsquo;s critical to implement robust security measures from the outset to protect your GCP resources and data from unauthorized access and potential breaches. We will follow Google&rsquo;s recommended security best practices.</p><h3 id=gcp-organization-setup-recommended-for-businesses>GCP Organization Setup (Recommended for Businesses)<a class=td-heading-self-link href=#gcp-organization-setup-recommended-for-businesses aria-label="Heading self-link"></a></h3><p>If you are using Google Workspace or Cloud Identity, setting up a GCP Organization is highly recommended. An Organization is the root node of the Google Cloud resource hierarchy and provides centralized control over all your GCP resources, projects, and billing. It allows you to define organization-wide policies and manage IAM permissions effectively. However, setting up a GCP organization with free tier Workspaces or Cloud Identity requires at minium a paid domain with email access - <strong>which is out-of-scope for our requirements</strong>.</p><ul><li>Learn more about <a href=https://cloud.google.com/resource-manager/docs/creating-managing-organization>Creating and Managing Organizations</a>. This is a foundational step for robust governance.</li><li>Visit <a href="https://support.google.com/a/answer/6043576?hl=en&amp;ref_topic=4388346&amp;sjid=6365213940035972062-NC">Sign-Up for Google Workspace</a> to create a new Google Workspace, or <a href="https://support.google.com/cloudidentity/answer/7389973?hl=en">Sign-Up for Cloud Identity</a> for Cloud Identity to register users with limited access to Google Services.</li></ul><p>GCP uses Google Accounts for authentication. For managing users, especially in a team or enterprise setting, it&rsquo;s best to use Google Workspace or Cloud Identity. These services act as your identity provider.</p><ul><li><strong>Create Users/Groups</strong>: <a href=https://cloud.google.com/iam/docs/groups-in-cloud-console>Manage your users and create groups</a> (e.g., <code>project-admins</code>, <code>project-developers</code>) within your Google Workspace or Cloud Identity admin console. Managing users in Cloud Identity.</li><li><strong>Enforce Multi-Factor Authentication (MFA/2SV)</strong>: Crucially, enforce 2-Step Verification (Google&rsquo;s term for MFA) for all Google Accounts that will access GCP. This is configured at the Google Account level or enforced via Google Workspace/Cloud Identity policies. Deploy 2-Step Verification.</li><li><strong>Grant IAM Roles</strong>: In GCP, you <a href=https://cloud.google.com/iam/docs/grant-role-console>Grant IAM roles</a> to principals (users, groups, service accounts) on specific resources (Organization, Folders, Projects). Start by granting roles to your Google Groups. For example, grant the <code>roles/owner</code> or more specific administrative roles (e.g., <code>roles/resourcemanager.projectCreator</code>, <code>roles/billing.admin</code>) to your <code>project-admins</code> group at the Organization or Folder level. Follow the principle of least privilege. Understanding IAM Roles.</li><li><strong>Accessing the GCP Console</strong>: Users will log in to the <a href=https://cloud.google.com>Google Cloud Console</a> using their Google Account credentials.</li></ul><h3 id=gcp-projects>GCP Projects<a class=td-heading-self-link href=#gcp-projects aria-label="Heading self-link"></a></h3><p>A GCP Project is the base-level organizing entity for everything you do in Google Cloud. Think of it as a container for all your cloud resources. All GCP resources you create, such as Virtual Machines (Compute Engine instances), Cloud Storage buckets, BigQuery datasets, Cloud SQL instances, IAM Roles and Security Permissions, etc., must belong to a project. We&rsquo;ll need to <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>Create a GCP Project</a> in order to finished the setup steps.</p><p>Before continuing, we need to enable the following APIs</p><ul><li>Enable <a href=https://console.developers.google.com/apis/library/cloudresourcemanager.googleapis.com>Cloud Resource Manager API</a></li><li>Enable <a href=https://console.cloud.google.com/apis/library/iam.googleapis.com>Identity And Access Management (IAM) API</a></li></ul><h3 id=cli-access-for-users>CLI Access for Users<a class=td-heading-self-link href=#cli-access-for-users aria-label="Heading self-link"></a></h3><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Initialize gcloud CLI and login with your Google Account</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># This command will open a browser window for authentication.</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># It will also prompt you to choose or create a default project and region/zone.</span>
</span></span><span style=display:flex><span>  gcloud init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># Alternatively, to just log in (if gcloud is already initialized):</span>
</span></span><span style=display:flex><span>  gcloud auth login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># To list authenticated accounts:</span>
</span></span><span style=display:flex><span>  gcloud auth list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic># To set your default project:</span>
</span></span><span style=display:flex><span>  gcloud config <span style=color:#204a87>set</span> project *<span style=color:#ce5c00;font-weight:700>[</span>YOUR_PROJECT_ID<span style=color:#ce5c00;font-weight:700>]</span>*
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=service-account-setup-programmatic-access>Service Account Setup (Programmatic Access)<a class=td-heading-self-link href=#service-account-setup-programmatic-access aria-label="Heading self-link"></a></h2><p>For applications, scripts, or CI/CD pipelines that need to interact with GCP APIs programmatically, you should use Service Accounts. Avoid using user credentials for programmatic access.</p><h3 id=programmatic-steps>Programmatic Steps<a class=td-heading-self-link href=#programmatic-steps aria-label="Heading self-link"></a></h3><p>You can perform service account setup and permissions assignment using the Google Cloud CLI (<code>gcloud</code>). The following steps mirror the console steps above:</p><ul class="nav nav-tabs justify-content-end" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=shell aria-controls=tabs-01-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li><li class=nav-item><button class=nav-link id=tabs-01-03-tab data-bs-toggle=tab data-bs-target=#tabs-01-03 role=tab data-td-tp-persist=hcl aria-controls=tabs-01-03 aria-selected=false>
<span style=vertical-align:middle><img src=https://cdn.simpleicons.org/terraform/5835CC alt="Terraform icon" style=height:1em;vertical-align:middle;margin-right:.3em></span>
Terraform</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a new service account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/creating-managing-service-accounts#gcloud</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud iam service-accounts create example-service-account <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --description<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Example Service Account for automation&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --display-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Example Service Account&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Grant roles to the service account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/granting-roles-to-service-accounts#gcloud</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountUser&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (Optional) Grant additional roles as needed</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Example: Security Admin</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gcloud projects add-iam-policy-binding $GCP_PROJECT_ID \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --member=&#34;serviceAccount:example-service-account@${GCP_PROJECT_ID}.iam.gserviceaccount.com&#34; \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --role=&#34;roles/iam.securityAdmin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Impersonate the service account for short-lived credentials</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/docs/authentication/use-service-account-impersonation#gcloud</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud config <span style=color:#204a87>set</span> auth/impersonate_service_account example-service-account@<span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Remove IAM policy bindings for the service account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (Repeat for each role previously assigned)</span>
</span></span><span style=display:flex><span>gcloud projects remove-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountUser&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud projects remove-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:example-service-account@</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.iam.gserviceaccount.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># (Optional) Remove any additional roles as needed</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gcloud projects remove-iam-policy-binding $GCP_PROJECT_ID \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --member=&#34;serviceAccount:example-service-account@${GCP_PROJECT_ID}.iam.gserviceaccount.com&#34; \</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   --role=&#34;roles/iam.securityAdmin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete the service account</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts delete <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  example-service-account@<span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-03 role=tabpanel aria-labelled-by=tabs-01-03-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HCL data-lang=HCL><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## ---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## GCP PROVIDER
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Configures the GCP provider with OIDC Connect via ENV Variables.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## ---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>provider</span> <span style=color:#4e9a06>&#34;google&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  alias</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tokengen&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## GCP SERVICE ACCOUNT MODULE
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## This module provisions a GCP service account along with associated roles and security groups.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Parameters:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `IMPERSONATE_SERVICE_ACCOUNT_EMAIL`: Existing GCP service account email to impersonate for new SA creation.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `new_service_account_name`: New service account name.\\
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `role_list`: List of roles to assign to the new service account.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## Providers:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## - `google.tokengen`: Alias for the GCP provider for generating service accounts.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>##---------------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>module</span> <span style=color:#4e9a06>&#34;gcp_service_account&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#000>  source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;../&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  IMPERSONATE_SERVICE_ACCOUNT_EMAIL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>var</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>IMPERSONATE_SERVICE_ACCOUNT_EMAIL</span>
</span></span><span style=display:flex><span><span style=color:#000>  new_service_account_name</span>          <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;example-service-account&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>  providers</span> <span style=color:#ce5c00;font-weight:700>=</span> {
</span></span><span style=display:flex><span><span style=color:#000>    google.tokengen</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>google</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>tokengen</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><p>For more details, see the <a href=https://cloud.google.com/sdk/gcloud/reference/iam/service-accounts/>gcloud CLI documentation</a>.</p><h3 id=console>Console<a class=td-heading-self-link href=#console aria-label="Heading self-link"></a></h3><p>Create a <a href=https://cloud.google.com/iam/docs/service-accounts-create>New Service Account</a> in your GCP project, and give it a descriptive name and ID. Once created, make sure to <a href=https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role>Grant Principal Access</a> to the Service Account using your project account with the following roles:</p><ul><li>Service Account Token Creator</li><li>Service Account User</li></ul><p>This will allow users to authenticate and interact with GCP using the Service Account with controlled permissions.</p><h4 id=grant-permissions-iam-roles--conditions>Grant Permissions (IAM Roles & Conditions)<a class=td-heading-self-link href=#grant-permissions-iam-roles--conditions aria-label="Heading self-link"></a></h4><p>Grant the necessary IAM roles to this service account on the specific resources it needs to access follow the principle of least privilege. Under <strong>Permissions</strong>, and selecting <strong>Manage Access</strong> in the Service Account view, is where we will be able to add IAM Roles. For our example, we&rsquo;ll assign the following roles to help manage later steps:</p><ul><li>Security Admin</li><li>Service Account Admin</li></ul><p>More discovery and evaluation is needed on hardening security with IP restrictions using <a href=https://cloud.google.com/iam/docs/conditions-overview>IAM Conditions</a> and <a href=https://cloud.google.com/iam/docs/conditions-attribute-reference#request>Condition Attributes</a>. Currently, only organizations are able to create <a href=https://cloud.google.com/access-context-manager/docs/create-custom-access-level>Access-Context-Managers</a> to manage IAM Condition level IP restrictions.</p><p>It&rsquo;s encourage to <a href=https://cloud.google.com/resource-manager/docs/organization-policy/restricting-service-accounts#disable_service_account_key_creation>Disable Service Account Key Creation</a> with Organizational IAM Policies, but this is only available to GCP projects belonging to an Organization.</p><h4 id=setup-short-lived-keys-with-service-account-impersonation>Setup Short-Lived Keys with Service Account Impersonation<a class=td-heading-self-link href=#setup-short-lived-keys-with-service-account-impersonation aria-label="Heading self-link"></a></h4><p><a href=https://cloud.google.com/docs/authentication/use-service-account-impersonation>Service Account Impersonation</a> in GCP allows a principal (like a user or another service account) to temporarily assume the identity and permissions of a specific service account. This is achieved by granting the principal the &ldquo;Service Account Token Creator&rdquo; role on the target service account.</p><p>Instead of directly using the target service account&rsquo;s long-lived keys, the principal requests short-lived credentials for that service account, effectively acting as that service account for a limited time and with its defined permissions. This is a security best practice as it avoids the need to distribute service account keys and allows for more granular and temporary access control.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-42e62deeade8d37e64b220e78934a681>2 - Terraform Backend</h1><div class=lead>GCP - Configuring Google Cloud Storage (GCS) as a remote backend for Terraform state, an alternative to Terraform Cloud workspaces.</div><h1 id=terraform-backend-with-google-cloud-storage>Terraform Backend with Google Cloud Storage<a class=td-heading-self-link href=#terraform-backend-with-google-cloud-storage aria-label="Heading self-link"></a></h1><p>Using Google Cloud Storage (GCS) as the backend for Terraform state is a robust and common practice for managing infrastructure as code on GCP. By storing Terraform state in a GCS bucket, teams can benefit from Google Cloud&rsquo;s strong security features, such as encryption at rest and in transit, fine-grained access control with IAM, and object versioning for state history and recovery. GCS provides a highly durable and available storage solution, ensuring that Terraform state is consistently accessible. This setup allows teams to use IAM Service Accounts and impersonation to manage access to the state files, adhering to the principle of least privilege, similar to using IAM Roles in other cloud environments. Furthermore, it integrates well with other GCP services and CI/CD pipelines for automated and monitored Terraform workflows.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p ~/development/test/example_gcp_tf_backend
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_gcp_tf_backend
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure GCloud CLI Application-Default-Credentials</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/docs/authentication/application-default-credentials</span>
</span></span><span style=display:flex><span>gcloud auth application-default login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Setting environment variables</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Or set manually: &#34;your-gcp-project-id&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_REGION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;us-central1&#34;</span> <span style=color:#8f5902;font-style:italic># Choose your preferred region</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>TERRAFORM_GCS_BUCKET_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>-tfstate-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 4<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span> <span style=color:#8f5902;font-style:italic># Must be globally unique</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>TERRAFORM_GCS_PREFIX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;sandbox/terraform.tfstate&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Grant StorageAdmin Role to Service Account</span>
</span></span><span style=display:flex><span>gsutil iam ch serviceAccount:<span style=color:#000>$GCP_SA_EMAIL</span>:objectAdmin gs://<span style=color:#4e9a06>${</span><span style=color:#000>TERRAFORM_GCS_BUCKET_NAME</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a GCS Bucket for Terraform State</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/storage/docs/creating-buckets#gsutil</span>
</span></span><span style=display:flex><span>gsutil mb -p <span style=color:#000>$GCP_PROJECT_ID</span> -l <span style=color:#000>$GCP_REGION</span> gs://<span style=color:#000>$TERRAFORM_GCS_BUCKET_NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Enable Object Versioning on the Bucket (Crucial for state history and preventing accidental data loss)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/storage/docs/object-versioning#gsutil</span>
</span></span><span style=display:flex><span>gsutil versioning <span style=color:#204a87>set</span> on gs://<span style=color:#000>$TERRAFORM_GCS_BUCKET_NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Configure Terraform</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; backend.conf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>bucket                      = &#34;$TERRAFORM_GCS_BUCKET_NAME&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>prefix                      = &#34;$TERRAFORM_GCS_PREFIX&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; terraform.tfvars
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>gcp_project_id = &#34;$GCP_PROJECT_ID&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>gcp_region     = &#34;$GCP_REGION&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; variables.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;gcp_project_id&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;GCP Project ID for resource deployment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>variable &#34;gcp_region&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type        = string
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  description = &#34;GCP Region for resource deployment&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOT &gt; main.tf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>/* GCS managed terraform state - configuration is in backend.conf */
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>terraform {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  required_providers {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    google = {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      source  = &#34;hashicorp/google&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version = &#34;~&gt; 5.0&#34; # Specify a version constraint
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  backend &#34;gcs&#34; {} // Configuration will be loaded from backend.conf
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>/* Google Cloud Provider Configuration */
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>provider &#34;google&#34; {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  project = var.gcp_project_id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  region  = var.gcp_region
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  // Terraform will use Application Default Credentials (ADC) of the user running it.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  // For CI/CD or specific service account usage for resource management,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  // you can configure &#39;credentials = file(&#34;path/to/sa-key.json&#34;)&#39; or use Workload Identity Federation.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Test Terraform</span>
</span></span><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># terraform apply --auto-approve # (Optional: Add a dummy resource to main.tf to test apply)</span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure environment variables are set from the Create step</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Tear Down Terraform managed resources (if any were created by &#39;terraform apply&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_gcp_tf_backend
</span></span><span style=display:flex><span>terraform destroy --auto-approve
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Delete GCS Bucket and all its objects (including versions)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The &#39;-m&#39; flag enables multi-threaded/multi-processing operations.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The &#39;-r&#39; flag enables recursive deletion.</span>
</span></span><span style=display:flex><span>gsutil -m rm -r gs://<span style=color:#000>$TERRAFORM_GCS_BUCKET_NAME</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Clean up local Terraform files</span>
</span></span><span style=display:flex><span>rm -f backend.conf main.tf variables.tf terraform.tfvars terraform.tfstate*
</span></span><span style=display:flex><span>rm -rf .terraform .terraform.lock.hcl
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><h3 id=create-gcs-bucket>Create GCS Bucket<a class=td-heading-self-link href=#create-gcs-bucket aria-label="Heading self-link"></a></h3><p>Create a <a href=https://cloud.google.com/storage/docs/creating-buckets>GCS Bucket</a> for the terraform <code>tfstate</code>. This will reduce the chance of sensitive data being committed to source. Configure the Bucket to have <strong>Standard Storage Classification</strong>, and <strong>Uniform Access Control</strong>. Enabling <a href=https://cloud.google.com/storage/docs/using-object-versioning>GCS Bucket Versioning</a> is critical for state management - to allow tracking of changes and enable recovery/ roll-back functionality.</p><h3 id=grant-service-account-permissions-to-gcs-bucket>Grant Service Account Permissions to GCS Bucket<a class=td-heading-self-link href=#grant-service-account-permissions-to-gcs-bucket aria-label="Heading self-link"></a></h3><p>Configure the newly created GCS Bucket for terraform <code>tfstate</code> to grant Service Account access to read/write following the <a href=https://cloud.google.com/storage/docs/access-control/using-iam-permissions>Bucket IAM Policies</a> guide. Ensure to assign the Service Account with <strong>Storage Object Admin</strong> role.</p><h3 id=configure-terraform-backend>Configure Terraform Backend<a class=td-heading-self-link href=#configure-terraform-backend aria-label="Heading self-link"></a></h3><p>Create a <code>backend.conf</code> file to configure <a href=https://developer.hashicorp.com/terraform/language/backend/gcs>GCS Terraform Backend</a>. Input the following contents into the file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#000>bucket</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_GCS_BUCKET_NAME]&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>prefix</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;[INSERT_GCS_BUCKET_PREFIX]&#34;</span>
</span></span></code></pre></div><p>Now Terraform will be configured to store its state in GCS. Also, we&rsquo;ve omitted configuration <code>impersonate_service_account</code>, as the <a href=https://cloud.google.com/docs/authentication/application-default-credentials>Google Application Default Credentials</a> (ADC) will be automatically impersonating our Service Account when we configure <code>gcloud cli</code> impersonation.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># From New Account Setup</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gcloud config set auth/impersonate_service_account $GCP_SA_EMAIL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud auth application-default login
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>terraform init -backend-config<span style=color:#ce5c00;font-weight:700>=</span>backend.conf
</span></span><span style=display:flex><span>terraform plan
</span></span><span style=display:flex><span>terraform apply --auto-approve
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9bcd402fa4d9352b990c1fe87d0421ce>3 - OpenID Connect</h1><div class=lead>GCP - Modernized Security for GitOps & CI/CD with GitHub Actions using Workload Identity Federation.</div><h1 id=openid-connect-oidc-with-github-actions-and-gcp-workload-identity-federation>OpenID Connect (OIDC) with GitHub Actions and GCP Workload Identity Federation<a class=td-heading-self-link href=#openid-connect-oidc-with-github-actions-and-gcp-workload-identity-federation aria-label="Heading self-link"></a></h1><p>Google Cloud&rsquo;s <a href=https://cloud.google.com/iam/docs/workload-identity-federation>Workload Identity Federation</a> allows identities from external OpenID Connect (OIDC) providers, like GitHub Actions, to impersonate Google Cloud service accounts. This enables your GitHub Actions workflows to securely access GCP resources without needing to manage or store long-lived service account keys in GitHub. Instead, workflows obtain short-lived access tokens, enhancing security and simplifying credential management for CI/CD pipelines.</p><h2 id=cli-steps>CLI Steps<a class=td-heading-self-link href=#cli-steps aria-label="Heading self-link"></a></h2><ul class="nav nav-tabs justify-content-end" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
<strong>Examples</strong>:</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=shell aria-controls=tabs-00-01 aria-selected=true>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Create) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Create)</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
<span style=vertical-align:middle><img src="data:image/svg+xml,%3Csvg%20height=%221024%22%20width=%22896%22%20xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath%20d=%22M831%20127H63c-35.35.0-64%2028.65-64%2064v640c0%2035.35%2028.65%2064%2064%2064h768c35.35.0%2064-28.65%2064-64V191c0-35.35-28.65-64-64-64zM127%20575l128-128L127%20319l64-64%20192%20192L191%20639l-64-64zm512%2064H383v-64h256v64z%22/%3E%3C/svg%3E" alt="CLI (Destroy) icon" style=height:1.5em;vertical-align:middle;margin-right:.3em></span>
CLI (Destroy)</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>mkdir -p ~/development/test/example_gcp_oidc
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/development/test/example_gcp_oidc
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 0. Prerequisites &amp; Configuration</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure gcloud CLI is installed, authenticated, and configured with a default project.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure GitHub CLI (gh) is installed and authenticated if using it to get repo details.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value project<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud projects describe <span style=color:#000>$GCP_PROJECT_ID</span> --format<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;value(projectNumber)&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_OWNER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;your-github-username-or-org&#34;</span> <span style=color:#8f5902;font-style:italic># Replace with your GitHub username or organization</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GH_REPO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;your-github-repo-name&#34;</span>    <span style=color:#8f5902;font-style:italic># Replace with your GitHub repository name</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_USER_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>gcloud config get-value account<span style=color:#204a87;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic># Your GCP user email, for optional SA impersonation</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>POOL_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;github-pool-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 2<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>PROVIDER_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;github-provider-</span><span style=color:#204a87;font-weight:700>$(</span>openssl rand -hex 2<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 1. Grant Workload Identity Pool Permissions to Service Account</span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:</span><span style=color:#000>$GCP_SA_EMAIL</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.workloadIdentityPoolAdmin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 1. Create a Workload Identity Pool</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/create</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools create <span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --display-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;GitHub Actions Pool&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --description<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Pool for GitHub Actions OIDC federation&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 2. Create a Workload Identity Provider in the Pool for GitHub</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># https://cloud.google.com/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/create</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools providers create-oidc <span style=color:#000>$PROVIDER_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --workload-identity-pool<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --issuer-uri<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;https://token.actions.githubusercontent.com&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --allowed-audiences<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;https://iam.googleapis.com/projects/</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/locations/global/workloadIdentityPools/</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/providers/</span><span style=color:#4e9a06>${</span><span style=color:#000>PROVIDER_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --display-name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;GitHub OIDC Provider&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --description<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Provider for GitHub Actions&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --attribute-mapping<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository,attribute.repository_owner=assertion.repository_owner,attribute.ref=assertion.ref&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --attribute-condition<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;assertion.repository == &#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39; &amp;&amp; assertion.ref == &#39;refs/heads/main&#39;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The --attribute-condition above restricts this provider to only issue credentials for tokens from the specified repo and main branch.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># You can make it broader (e.g., only `assertion.repository_owner == &#39;${GH_OWNER}&#39;`) and control access via IAM conditions on the service account binding.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 3. Create a dedicated OIDC SA &amp; Grant necessary permissions on GCP resources</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Adjust the role (e.g., roles/iam.securityReviewer, roles/run.invoker, roles/editor) based on what your workflow needs to do.</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_POOL_SA_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span>-sa
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GCP_POOL_SA_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_POOL_SA_ID</span><span style=color:#4e9a06>}</span>@<span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_ID</span><span style=color:#4e9a06>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>gcloud iam service-accounts create <span style=color:#000>$GCP_POOL_SA_ID</span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_POOL_SA_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/storage.admin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 4. Allow GitHub Actions (via the Workload Identity Provider) to impersonate the Service Account</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This binds the GitHub OIDC subject (filtered by the provider&#39;s attribute-condition) to the SA.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># The subject from GitHub OIDC token for a specific repo and ref is `repo:OWNER/REPO_NAME:ref:refs/heads/main`</span>
</span></span><span style=display:flex><span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;repo:</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:ref:refs/heads/main&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud iam service-accounts add-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.workloadIdentityUser&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;principal://iam.googleapis.com/projects/</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/locations/global/workloadIdentityPools/</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/subject/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 5. (Optional) Allow your GCP user to impersonate the Service Account for testing/local development</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts add-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_USER_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ensure environment variables from the Create step are set, or re-define them:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. (Optional) Remove GCP user&#39;s permission to impersonate the Service Account</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts remove-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.serviceAccountTokenCreator&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_USER_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. Remove GitHub Actions&#39; permission to impersonate the Service Account</span>
</span></span><span style=display:flex><span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;repo:</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_OWNER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_REPO</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:ref:refs/heads/main&#34;</span> <span style=color:#8f5902;font-style:italic># Reconstruct if not set</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts remove-iam-policy-binding <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/iam.workloadIdentityUser&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;principal://iam.googleapis.com/projects/</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_PROJECT_NUMBER</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/locations/global/workloadIdentityPools/</span><span style=color:#4e9a06>${</span><span style=color:#000>POOL_ID</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/subject/</span><span style=color:#4e9a06>${</span><span style=color:#000>GH_SUBJECT_ASSERTION</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. Remove roles granted to the Service Account (example: roles/iam.securityReviewer)</span>
</span></span><span style=display:flex><span>gcloud projects remove-iam-policy-binding <span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --member<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;serviceAccount:</span><span style=color:#4e9a06>${</span><span style=color:#000>GCP_POOL_SA_EMAIL</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --role<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;roles/storage.admin&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. Delete the Service Account</span>
</span></span><span style=display:flex><span>gcloud iam service-accounts delete <span style=color:#000>$GCP_POOL_SA_EMAIL</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. Delete the Workload Identity Provider</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools providers delete <span style=color:#000>$PROVIDER_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --workload-identity-pool<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 6. Delete the Workload Identity Pool</span>
</span></span><span style=display:flex><span>gcloud iam workload-identity-pools delete <span style=color:#000>$POOL_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --project<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$GCP_PROJECT_ID</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --location<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;global&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  </span></span></code></pre></div></div></div><h2 id=console-steps>Console Steps<a class=td-heading-self-link href=#console-steps aria-label="Heading self-link"></a></h2><h3 id=1-create-workload-identity-pool>1. Create Workload Identity Pool<a class=td-heading-self-link href=#1-create-workload-identity-pool aria-label="Heading self-link"></a></h3><p>Start by creating a new <a href=https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers>Workload Identity Pool</a> - provide a name like <code>github-actions-pool</code>. The Workload Identity Pool (WIP) will centralize the collection of possible OIDC providers we can configure to provide least-priviledged access into our GCP Project.</p><h3 id=2-add-a-provider-to-the-pool-for-github-actions>2. Add a Provider to the Pool for GitHub Actions<a class=td-heading-self-link href=#2-add-a-provider-to-the-pool-for-github-actions aria-label="Heading self-link"></a></h3><p>After creating our WIP, we can now <a href=https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers#manage-providers>Manage Providers</a>. Setup instructions for <a href=https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-google-cloud-platform#adding-a-google-cloud-workload-identity-provider>OIDC between GCP and Github</a> are sparse, but more cross-platform details can be found in the <a href=https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect#configuring-the-subject-in-your-cloud-provider>Security Hardening Guide</a>. Use the following details to setup Github OIDC provider in our WIP.</p><ul><li><strong>Issuer (URL)</strong> Enter <code>https://token.actions.githubusercontent.com</code>.</li><li><strong>Attribute Mapping</strong> details/ maps the <a href=https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token>OIDC Token Claims</a> for CEL expression filtering<ul><li><code>google.subject</code>: <code>assertion.sub</code></li><li><code>attribute.actor</code>: <code>assertion.actor</code></li><li><code>attribute.aud</code>: <code>assertion.aud</code></li><li><code>attribute.repository</code>: <code>assertion.repository</code> (e.g., <code>your-owner/your-repo</code>)</li><li><code>attribute.repository_owner</code>: <code>assertion.repository_owner</code></li><li><code>attribute.ref</code>: <code>assertion.ref</code> (e.g., <code>refs/heads/main</code>)</li><li><code>attribute.environment</code>: <code>assertion.environment</code> (if you use GitHub environments)</li></ul></li><li><strong>Attribute Condition (Optional but Recommended)</strong>:<ul><li>This CEL expression filters which GitHub tokens are allowed by this provider.</li><li>Example for a specific repository and its main branch:
<code>assertion.repository == 'YOUR_GITHUB_OWNER/YOUR_GITHUB_REPO' && assertion.ref == 'refs/heads/main'</code></li><li>Example for any repository under a specific owner:
<code>assertion.repository_owner == 'YOUR_GITHUB_OWNER'</code></li></ul></li></ul><h3 id=3-create-service-accounts--grant-workload-identity-user-role>3. Create Service Account(s) & Grant Workload Identity User Role<a class=td-heading-self-link href=#3-create-service-accounts--grant-workload-identity-user-role aria-label="Heading self-link"></a></h3><p>You&rsquo;ll need one or more <a href=https://cloud.google.com/iam/docs/service-accounts-create>New Service Account</a> that your GitHub Actions workflows will impersonate. Configure the Workload Identity Pool (i.e., specific GitHub Actions workflows) with <a href=https://cloud.google.com/iam/docs/workload-identity-federation#access_management>WIP Access Management</a> to impersonate the service account(s). <a href=https://cloud.google.com/iam/docs/manage-access-service-accounts#grant-single-role>Grant Principal Access</a> to the Service Account with either of the following Principals:</p><ul><li>To allow workflows from a specific repository and specific branch (e.g., <code>main</code>):
<code>principal://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/subject/repo:GITHUB_OWNER/GITHUB_REPO_NAME:ref:refs/heads/main</code></li><li>To allow workflows from a specific repository and specific environment (e.g., <code>production</code>):
<code>principal://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/subject/repo:GITHUB_OWNER/GITHUB_REPO_NAME:environment:production</code>
<strong>Replace <code>PROJECT_NUMBER</code>, <code>POOL_ID</code>, <code>PROVIDER_ID</code>, <code>GITHUB_OWNER</code>, <code>GITHUB_REPO_NAME</code> with your actual values.</strong></li></ul><p><strong>Assign roles</strong>: <strong>Workload Identity User</strong> (<code>roles/iam.workloadIdentityUser</code>) to allow for Workload Identity Federation impersonation with the Service Account. Lastly, bind the necessary roles with least priviledges to operate. Repeat for other service accounts and GitHub principal combinations as needed. For example:
* <code>github-cicd-read-sa</code> might be impersonable by <code>repo:ORG/REPO:ref:refs/heads/*</code> (any branch).
* <code>github-cicd-deploy-sa</code> might be impersonable by <code>repo:ORG/REPO:ref:refs/heads/main</code> or <code>repo:ORG/REPO:environment:production</code>.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://example.org/mail aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Twitter aria-label=Twitter><a target=_blank rel=noopener href=https://example.org/twitter aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Stack Overflow" aria-label="Stack Overflow"><a target=_blank rel=noopener href=https://example.org/stack aria-label="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/docsy aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://example.org/slack aria-label=Slack><i class="fab fa-slack"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Developer mailing list" aria-label="Developer mailing list"><a target=_blank rel=noopener href=https://example.org/mail aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2025
<span class=td-footer__authors>Docsy Authors | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/docs_blog/js/main.min.115f19af160d1221e5d7ad0bb0ea2960832ce0857063f349661781f47be40740.js integrity="sha256-EV8ZrxYNEiHl160LsOopYIMs4IVwY/NJZheB9HvkB0A=" crossorigin=anonymous></script>
<script defer src=/docs_blog/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script>
<script src=/docs_blog/js/tabpane-persist.js></script></body></html>